<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BigEyes · 사진 요약 + 쿠팡 최저가</title>
<meta name="theme-color" content="#0b1020"/>
<style>
:root { --bg:#0b1020; --card:#121833; --ink:#e8ecff; --muted:#9aa5d1; --accent:#7aa2ff; --line:#223066; }
*{box-sizing:border-box}
body{margin:0;color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Apple SD Gothic Neo,Malgun Gothic,sans-serif;background:#0b1020}
header{position:sticky;top:0;padding:16px;border-bottom:1px solid var(--line);background:#0b1020cc;backdrop-filter:blur(6px);text-align:center}
h1{margin:0;font-size:20px}
main{max-width:900px;margin:0 auto;padding:16px;display:grid;gap:14px}
.card{background:#121833e8;border:1px solid var(--line);border-radius:16px;padding:16px}
.lead{text-align:center;line-height:1.8}
.credit{font-weight:700;color:#b9c8ff}
.row{display:grid;gap:10px}
.grid2{display:grid;gap:10px;grid-template-columns:repeat(2,1fr)}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:14px 16px;border-radius:14px;background:#1a2a6b;border:1px solid #3350aa;color:#fff;font-weight:700;cursor:pointer}
.btn.secondary{background:#0e1430;border-color:#2a3a7a;color:#c9d3ff}
.btn[disabled]{opacity:.5;cursor:not-allowed}
input[type="file"]{display:none}
input[type="text"]{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #2a3a7a;background:#0e1430;color:#e8ecff}
textarea.summary-box{
  width:100%; min-height:220px; padding:12px 14px;
  border-radius:12px; border:1px solid #2a3a7a;
  background:#0e1430; color:#e8ecff; line-height:1.7; font-size:15px;
  white-space:pre-wrap; resize:vertical;
}
.preview{width:100%;max-height:380px;object-fit:contain;border-radius:12px;border:1px solid var(--line)}
.hidden{display:none}
.small{font-size:13px;color:var(--muted)}
.section-title{margin:0 0 6px}
</style>
</head>
<body>
<header><h1>👀 BigEyes · 사진 요약 + 쿠팡 최저가</h1></header>

<main>
  <!-- 인트로 -->
  <section class="card">
    <div class="lead">
      <strong>사진 속 작은 글씨 요약</strong> + <strong>쿠팡 최저가 바로가기</strong><br/>
      자동 추출된 검색어는 필요하면 <em>수정</em>하세요.
    </div>
    <p style="text-align:center;margin:8px 0 0">
      <span id="creditTop" class="credit">(이용 가능 건수 : 0000건)</span>
    </p>
  </section>

  <!-- STEP 1: 업로드 -->
  <section id="stepUpload" class="card">
    <div class="row" style="grid-template-columns:1fr auto;align-items:center">
      <h2 class="section-title">1) 사진 선택</h2>
      <div id="creditTop2" class="credit"></div>
    </div>

    <div class="row">
      <label class="btn">
        📷 카메라로 찍기
        <input id="fileCam" type="file" accept="image/*" capture="environment">
      </label>
      <label class="btn">
        📁 파일에서 선택
        <input id="filePick" type="file" accept="image/*">
      </label>
    </div>

    <img id="imgPrev" class="preview hidden" alt="preview"/>

    <!-- 액션: 두 선택지 -->
    <div class="grid2" style="margin-top:8px">
      <button id="btnAnalyze" class="btn hidden">🔍 작은 글씨 요약</button>
      <button id="btnCoupangFlow" class="btn secondary hidden">🛒 쿠팡 최저가 가기</button>
    </div>
    <p class="small">※ 같은 사진에 대해 OCR은 한 번만 차감됩니다.</p>
  </section>

  <!-- STEP 2-A: 보고서 형태 요약(읽기 전용) -->
  <section id="stepSummary" class="card hidden">
    <h2 class="section-title">2) 요약 결과(보고서)</h2>
    <textarea id="sumReadOnly" class="summary-box" readonly></textarea>
    <div class="row" style="grid-template-columns:1fr;align-items:center">
      <!-- 요청: 이 화면에서는 최저가 버튼을 노출하지 않음 -->
      <button id="btnBackSum" class="btn secondary">⬅ 이전 화면으로</button>
    </div>
    <p class="small">※ 최저가 이동은 다음 화면(검색어 확인 단계)에서 진행할 수 있어요.</p>
  </section>

  <!-- STEP 2-B: 쿠팡 키워드 확인/수정 -->
  <section id="stepCoupang" class="card hidden">
    <h2 class="section-title">2) 쿠팡 검색 전 확인</h2>
    <div class="row">
      <label><strong>요약 내용</strong></label>
      <textarea id="sumBox" class="summary-box" readonly></textarea>
      <div class="grid2">
        <button id="btnEditSum" class="btn secondary">✏️ 수정</button>
        <span class="small" style="align-self:center">※ 필요할 때만 수정하세요.</span>
      </div>

      <label><strong>검색어</strong></label>
      <input id="kwFinal" type="text" placeholder="쿠팡 검색어" />

      <div class="grid2" style="margin-top:8px">
        <button id="btnBack2" class="btn secondary">⬅ 이전 화면으로</button>
        <button id="btnGoCoupang" class="btn">🛒 최저가 보러가기</button>
      </div>
    </div>
  </section>

  <!-- 보상형 광고만 유지 -->
  <section class="card">
    <h3 class="section-title">🎁 보상형 광고</h3>
    <p class="small">광고를 시청하면 이용 가능 건수가 <strong>1회</strong> 충전됩니다.</p>
    <button id="btnReward" class="btn">광고 보고 1회 충전</button>
  </section>
</main>

<script>
/* ===== 설정 ===== */
const API_BASE = window.location.origin;
const USE_MOCK = false; // 만약 이 변수가 있다면 강제로 실서버 모드
const PARTNER_ID = 'AF2974050';      // 쿠팡 파트너스
const SUB_ID     = 'bigeyes';        // 추적 구분자
const LS_KEY = 'be_credits_v08';
const DEFAULT_CREDITS = 3;
const MAX_CREDITS = 9999;

/* ===== 상태/요소 ===== */
let lastImageBlob = null;
let lastOCR = null;                  // { product, coreSummary, categories[] ... }
let ocrDoneForThisImage = false;

const $ = id => document.getElementById(id);
const creditTop=$('creditTop'), creditTop2=$('creditTop2');
const stepUpload=$('stepUpload'), stepSummary=$('stepSummary'), stepCoupang=$('stepCoupang');
const fileCam=$('fileCam'), filePick=$('filePick'), imgPrev=$('imgPrev');
const btnAnalyze=$('btnAnalyze'), btnCoupangFlow=$('btnCoupangFlow');
const sumReadOnly=$('sumReadOnly'), btnBackSum=$('btnBackSum');
const sumBox=$('sumBox'), btnEditSum=$('btnEditSum'), kwFinal=$('kwFinal');
const btnBack2=$('btnBack2'), btnGoCoupang=$('btnGoCoupang');
const btnReward=$('btnReward');

/* ===== 크레딧 ===== */
function clamp(n,lo,hi){return Math.max(lo,Math.min(hi,n))}
function pad4(n){return String(n).padStart(4,'0')}
function loadCredits(){const n=parseInt(localStorage.getItem(LS_KEY)||`${DEFAULT_CREDITS}`,10);return clamp(Number.isFinite(n)?n:DEFAULT_CREDITS,0,MAX_CREDITS)}
function saveCredits(n){const v=clamp(n,0,MAX_CREDITS);localStorage.setItem(LS_KEY,String(v));renderCredits(v)}
function renderCredits(v=loadCredits()){
  const txt=`(이용 가능 건수 : ${pad4(v)}건)`;
  creditTop.textContent=txt; creditTop2.textContent=txt;
  const blocked=v<=0; fileCam.disabled=blocked; filePick.disabled=blocked;
}
(function initCredits(){const p=new URLSearchParams(location.search); if(p.has('reset')) localStorage.removeItem(LS_KEY); renderCredits();})();

/* ===== 유틸 ===== */
// 전송 전 이미지 리사이즈/압축 (긴 변 1600px, JPEG q=0.8)
async function toBase64(file, maxSide=1600, quality=0.8){
  const img = await new Promise(res=>{
    const i = new Image();
    i.onload = ()=>res(i);
    i.src = URL.createObjectURL(file);
  });
  const {width, height} = img;
  const scale = Math.min(1, maxSide / Math.max(width, height));
  const w = Math.round(width * scale), h = Math.round(height * scale);
  const canvas = document.createElement('canvas');
  canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(img, 0, 0, w, h);
  const dataUrl = canvas.toDataURL('image/jpeg', quality);
  return dataUrl.split(',')[1]; // base64만 반환
}

function coupangAppUrl(q){return 'coupang://search?q='+encodeURIComponent(q)}
function coupangWebUrl(q){const base='https://www.coupang.com/np/search';const params=new URLSearchParams({q,channel:'user',lptag:PARTNER_ID,subId:SUB_ID});return `${base}?${params.toString()}`}
function buildSearchKeyword(product={}, fallback=''){
  const parts=[]; if(product.brand)parts.push(product.brand); if(product.model)parts.push(product.model); if(product.name)parts.push(product.name);
  if(Array.isArray(product.attrs)) parts.push(...product.attrs.slice(0,3));
  let q=parts.join(' ').replace(/\s+/g,' ').trim(); if(!q) q=(fallback||'').trim(); if(q.length>80) q=q.slice(0,80); return q;
}

/* ===== 파일 선택 ===== */
async function onPick(file){
  if(!file) return;
  if(loadCredits()<=0){ alert('잔여 건수가 없습니다. 광고 시청으로 충전해주세요.'); return; }
  lastImageBlob=file; imgPrev.src=URL.createObjectURL(file); imgPrev.classList.remove('hidden');
  btnAnalyze.classList.remove('hidden'); btnCoupangFlow.classList.remove('hidden');
  ocrDoneForThisImage=false; lastOCR=null;
}
fileCam.addEventListener('change',()=>onPick(fileCam.files?.[0]));
filePick.addEventListener('change',()=>onPick(filePick.files?.[0]));

/* ===== 보고서 렌더러 ===== */
function buildReport(payload){
  const lines=[];
  const domain = payload.domain ? `(${payload.domain})` : '';
  lines.push(`📝 보고서 ${domain}`.trim());
  lines.push('');
  // 핵심 요약
  const core = (payload.coreSummary||'').trim();
  if(core){
    lines.push('■ 핵심 요약');
    for(const l of core.split('\n').filter(Boolean)){
      const t = l.replace(/^\-\s?/, '').trim();
      lines.push(' - ' + t);
    }
    lines.push('');
  }
  // 카테고리
  const cats = Array.isArray(payload.categories)? payload.categories : [];
  for(const c of cats){
    const title = c.title || c.key || '세부정보';
    const sum = String(c.summary||'').trim();
    if(!sum) continue;
    lines.push(`■ ${title}`);
    for(const l of sum.split('\n').filter(Boolean)){
      const t = l.replace(/^\-\s?/, '').trim();
      lines.push(' - ' + t);
    }
    lines.push('');
  }
  return lines.join('\n');
}

/* ===== OCR (한 번만 차감) ===== */
async function ensureOCR(){
  if(!lastImageBlob) throw new Error('이미지를 선택하세요.');
  if(lastOCR) return lastOCR;
  if(!ocrDoneForThisImage){ const cur=loadCredits(); if(cur<=0) throw new Error('잔여 건수가 없습니다.'); saveCredits(cur-1); ocrDoneForThisImage=true; }
  if(USE_MOCK){
    await new Promise(r=>setTimeout(r,500));
    lastOCR={ 
      product:{brand:'라코스테',model:'L1212',name:'폴로 티셔츠',attrs:['남성','반팔','화이트']},
      coreSummary:'- 브랜드: 라코스테\n- 모델: L1212\n- 유형: 폴로 티셔츠\n- 특이사항: 면 100%, 기본핏',
      domain:'product_page',
      categories:[
        {key:'features', title:'✨ 핵심특징', summary:'- 면 100%\n- 기본핏\n- 카라 디자인'},
        {key:'price', title:'💰 가격·조건', summary:'- 변동 가능\n- 쿠팡에서 확인'},
        {key:'warnings', title:'⚠️ 주의', summary:'- 세탁 시 주의'}
      ]
    };
    return lastOCR;
  }else{
    const base64=await toBase64(lastImageBlob);
    const r=await fetch(`${API_BASE}/api/summarize`,{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({imageBase64:base64,lang:'ko'})
    });
    let data;
    try{ data=await r.json(); }
    catch{
      const text=await r.text().catch(()=> '');
      if(r.status===413 || /Entity Too Large/i.test(text)) throw new Error('이미지가 너무 큽니다. 사진 해상도를 낮추거나 압축 후 다시 시도하세요.');
      throw new Error(text?.slice(0,120) || '서버 응답을 읽지 못했습니다.');
    }
    if(!r.ok || !data?.success) throw new Error(data?.message||'요약 실패');
    lastOCR=data.payload; 
    return lastOCR;
  }
}

/* ===== ① 작은 글씨 요약(보고서 화면으로) ===== */
btnAnalyze.addEventListener('click', async ()=>{
  try{
    const payload=await ensureOCR();
    sumReadOnly.value=buildReport(payload);
    stepUpload.classList.add('hidden'); 
    stepSummary.classList.remove('hidden'); 
    window.scrollTo({top:0,behavior:'smooth'});
  }catch(e){ alert(e.message||'오류가 발생했습니다.'); }
});
btnBackSum.addEventListener('click', ()=>{
  stepSummary.classList.add('hidden'); 
  stepUpload.classList.remove('hidden'); 
});

/* ===== ② 쿠팡 플로우: 요약 한 칸 + 검색어 한 줄 ===== */
btnCoupangFlow.addEventListener('click', async ()=>{
  try{
    const payload=await ensureOCR();
    const baseSummary=(payload.coreSummary||'').trim();
    const p=payload.product||{};
    const infoLine=[p.brand,p.model,p.name,Array.isArray(p.attrs)?p.attrs.slice(0,3).join(', '):''].filter(Boolean).join(' · ');
    $('sumBox').value=[baseSummary, infoLine?`\n\n[제품] ${infoLine}`:''].join('');
    $('sumBox').readOnly=true; btnEditSum.textContent='✏️ 수정';
    kwFinal.value=buildSearchKeyword(p,'');
    stepUpload.classList.add('hidden'); stepCoupang.classList.remove('hidden'); window.scrollTo({top:0,behavior:'smooth'});
  }catch(e){ alert(e.message||'오류가 발생했습니다.'); }
});

let isEditingSummary=false;
btnEditSum.addEventListener('click', ()=>{
  isEditingSummary=!isEditingSummary;
  sumBox.readOnly=!isEditingSummary;
  btnEditSum.textContent=isEditingSummary?'✅ 수정 완료':'✏️ 수정';
  if(!isEditingSummary){
    const firstLine=(sumBox.value||'').split('\n').map(s=>s.trim()).filter(Boolean)[0]||'';
    if(firstLine && !kwFinal.value.trim()) kwFinal.value=firstLine.slice(0,80);
  }
});

btnGoCoupang.addEventListener('click', ()=>{
  const keyword=(kwFinal.value||'').trim();
  if(!keyword) return alert('검색어를 입력하세요.');
  const appU=coupangAppUrl(keyword), webU=coupangWebUrl(keyword);
  location.href=appU; setTimeout(()=>window.open(webU,'_blank','noopener,noreferrer'),400);
});

btnBack2.addEventListener('click', ()=>{ 
  stepCoupang.classList.add('hidden'); 
  stepUpload.classList.remove('hidden'); 
});

/* ===== 보상형 광고(+1) ===== */
btnReward.addEventListener('click', ()=>{ 
  saveCredits(loadCredits()+1); 
  alert('광고 시청 완료! 1회 충전되었습니다.'); 
});
</script>
</body>
</html>
