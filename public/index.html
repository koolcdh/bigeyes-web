<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸ‘€ BigEyes Â· ì‚¬ì§„ ìš”ì•½ + ì¿ íŒ¡ ìµœì €ê°€</title>
  <meta name="theme-color" content="#0b1020"/>
  <style>
    :root { --bg:#0b1020; --card:#121833; --ink:#e8ecff; --muted:#9aa5d1; --accent:#7aa2ff; --line:#223066; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--ink);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, Apple SD Gothic Neo, Malgun Gothic, sans-serif;
      background:
        radial-gradient(1200px 800px at 75% -10%, rgba(122,162,255,.18), transparent 60%),
        radial-gradient(900px 600px at 10% 10%, rgba(122,162,255,.10), transparent 55%),
        linear-gradient(180deg, #0b1020 0%, #070b17 100%),
        repeating-linear-gradient(45deg, rgba(255,255,255,0.03) 0px, rgba(255,255,255,0.03) 1px, transparent 1px, transparent 11px),
        repeating-linear-gradient(135deg, rgba(255,255,255,0.02) 0px, rgba(255,255,255,0.02) 1px, transparent 1px, transparent 11px);
      background-blend-mode: screen, screen, normal, overlay, overlay;
    }
    header{
      padding:18px; border-bottom:1px solid var(--line);
      position:sticky; top:0; z-index:10;
      background:rgba(11,16,32,.55); backdrop-filter:blur(6px);
      text-align:center;
    }
    h1{margin:0; font-size:22px; font-weight:800; display:flex; align-items:center; justify-content:center; gap:8px}
    main{max-width:900px; margin:0 auto; padding:16px; display:grid; gap:14px}
    .card{background:rgba(18,24,51,.92); border:1px solid var(--line); border-radius:16px; padding:16px; box-shadow:0 10px 40px rgba(0,0,0,.35)}
    .lead{font-size:16px; line-height:1.9; text-align:center}
    .credit{font-weight:700; color:#b9c8ff}
    .muted{color:var(--muted)}
    .row{display:grid; gap:10px}
    .grid2{display:grid; gap:10px; grid-template-columns:repeat(2,1fr)}
    .btn{display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:14px 16px; border-radius:14px; background:#1a2a6b; color:#fff; border:1px solid #3350aa; cursor:pointer; font-weight:700; font-size:17px}
    .btn.secondary{background:#0e1430; border-color:#2a3a7a; color:#c9d3ff; font-weight:600}
    .btn.block{width:100%}
    .btn[disabled]{opacity:.55; cursor:not-allowed}
    input[type="file"]{display:none}
    .preview{width:100%; max-height:380px; object-fit:contain; border-radius:12px; border:1px solid var(--line)}
    .hidden{display:none}
    .answer{white-space:pre-wrap; line-height:1.85; font-size:18px}
    .bul{margin:0; padding-left:1.1em} .bul li{margin:.25em 0}
    .banner-ad{margin-top:10px; border:1px dashed var(--line); border-radius:12px; padding:12px; text-align:center; color:#9fb1ff; background:#101738}
  </style>
</head>
<body>
<header>
  <h1>ğŸ‘€ BigEyes Â· ì‚¬ì§„ ìš”ì•½ + ì¿ íŒ¡ ìµœì €ê°€</h1>
</header>

<main>
  <!-- ì¸íŠ¸ë¡œ -->
  <section class="card">
    <div class="lead">
      <strong>ì‚¬ì§„ ì† ì‘ì€ ê¸€ì”¨ë¥¼ í•œëˆˆì— ìš”ì•½</strong><br/>
      ê·¸ë¦¬ê³  ì¶”ì¶œí•œ í‚¤ì›Œë“œë¡œ <strong>ì¿ íŒ¡ ìµœì €ê°€ ë°”ë¡œê°€ê¸°</strong>ê¹Œì§€!
    </div>
    <p class="center" style="margin:8px 0 0; text-align:center">
      <span id="creditMeter" class="credit">(ì´ìš© ê°€ëŠ¥ ê±´ìˆ˜ : 0000ê±´)</span>
    </p>
    <p class="center" style="margin:8px 0 0; font-size:13px; text-align:center">
      <a href="/privacy.html">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a> Â· <a href="/terms.html">ì´ìš©ì•½ê´€</a>
    </p>
  </section>

  <!-- STEP 1: ì—…ë¡œë“œ -->
  <section id="step-upload" class="card">
    <div class="row" style="grid-template-columns:1fr auto; align-items:center">
      <h2 style="margin:0">1) ì‚¬ì§„ ì„ íƒ</h2>
      <div class="credit" id="creditMeter2"></div>
    </div>

    <div class="row">
      <label class="btn block">
        ğŸ“· ì¹´ë©”ë¼ë¡œ ì°ê¸°
        <input id="inputCamera" type="file" accept="image/*" capture="environment">
      </label>
      <label class="btn block">
        ğŸ“ íŒŒì¼ì—ì„œ ì„ íƒ
        <input id="inputFile" type="file" accept="image/*">
      </label>
    </div>

    <img id="img" class="preview hidden" alt="preview"/>
    <div style="height:10px"></div>
    <button id="btnAnalyze" class="btn hidden">ğŸ” ì‘ì€ ê¸€ì”¨ ìš”ì•½</button>

    <div class="banner-ad">ë°°ë„ˆ ê´‘ê³  ì˜ì—­ (í”Œë ˆì´ìŠ¤í™€ë”)</div>
  </section>

  <!-- STEP 2: ì¹´í…Œê³ ë¦¬ -->
  <section id="step-categories" class="card hidden">
    <h2 style="margin:0 0 8px">2) ì¹´í…Œê³ ë¦¬ ì„ íƒ</h2>
    <div id="cats" class="row"></div>
    <div style="height:10px"></div>
    <button id="btnRetry1" class="btn secondary">â†» ë‹¤ì‹œ ì°ê¸°</button>
  </section>

  <!-- STEP 3: ê²°ê³¼ -->
  <section id="step-answer" class="card hidden">
    <h2 id="answerTitle" style="margin:0 0 6px"></h2>
    <div id="answer" class="answer"></div>
    <!-- ì¿ íŒ¡ ë²„íŠ¼ì´ ì—¬ê¸° ë¶™ìŠµë‹ˆë‹¤ -->
    <div style="height:12px"></div>
    <div class="grid2">
      <button id="btnBack" class="btn secondary">â¬… ì¹´í…Œê³ ë¦¬ë¡œ ëŒì•„ê°€ê¸°</button>
      <button id="btnRetry2" class="btn secondary">â†» ë‹¤ì‹œ ì°ê¸°</button>
    </div>
  </section>

  <!-- ë³´ìƒí˜• ê´‘ê³  -->
  <section class="card">
    <h3 style="margin:0 0 6px">ğŸ ë³´ìƒí˜• ê´‘ê³ </h3>
    <p class="muted" style="margin:0 0 8px">ê´‘ê³ ë¥¼ ì‹œì²­í•˜ë©´ ì´ìš© ê°€ëŠ¥ ê±´ìˆ˜ê°€ <strong>1íšŒ</strong> ì¶©ì „ë©ë‹ˆë‹¤.</p>
    <button id="btnReward" class="btn">ê´‘ê³  ë³´ê³  1íšŒ ì¶©ì „</button>
    <div id="rewardContainer" class="muted" style="margin-top:8px">ë¦¬ì›Œë“œ ê´‘ê³  ì˜ì—­ (í”Œë ˆì´ìŠ¤í™€ë”)</div>
  </section>
</main>

<script>
  // ===== ì„¤ì • =====
  // API ì„œë²„ ì£¼ì†Œ (ë¹„ìš°ë©´ Mockë¡œ ë™ì‘í•´ ë°”ë¡œ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥)
  const API_BASE = ''; // ì˜ˆ: 'https://your-server.com'
  const USE_MOCK = !API_BASE;

  // í¬ë ˆë”§(ê±´ìˆ˜)
  const MAX_CREDITS = 9999;
  const DEFAULT_CREDITS = 3;
  const LS_KEY_CREDITS = 'be_credits_v08';

  // ì¿ íŒ¡ íŒŒíŠ¸ë„ˆìŠ¤
  const PARTNER_ID = 'AF2974050';
  const SUB_ID     = 'bigeyes';

  // ===== ìœ í‹¸ =====
  const $ = (id)=>document.getElementById(id);
  const elCreditMeter  = $('creditMeter');
  const elCreditMeter2 = $('creditMeter2');
  const stepUpload = $('step-upload');
  const stepCats   = $('step-categories');
  const stepAnswer = $('step-answer');
  const inputCamera = $('inputCamera');
  const inputFile   = $('inputFile');
  const img         = $('img');
  const btnAnalyze  = $('btnAnalyze');
  const catsWrap    = $('cats');
  const answerBox   = $('answer');
  const answerTitle = $('answerTitle');
  const btnReward   = $('btnReward');
  const btnBack     = $('btnBack');
  const btnRetry1   = $('btnRetry1');
  const btnRetry2   = $('btnRetry2');

  function clamp(n, lo, hi){ return Math.max(lo, Math.min(hi, n)); }
  function pad4(n){ return String(n).padStart(4,'0'); }

  function loadCredits(){
    const n = parseInt(localStorage.getItem(LS_KEY_CREDITS) || `${DEFAULT_CREDITS}`, 10);
    return clamp(Number.isFinite(n) ? n : DEFAULT_CREDITS, 0, MAX_CREDITS);
  }
  function saveCredits(n){
    const v = clamp(n, 0, MAX_CREDITS);
    localStorage.setItem(LS_KEY_CREDITS, String(v));
    renderCredits(v);
    return v;
  }
  function renderCredits(v = loadCredits()){
    const txt = `(ì´ìš© ê°€ëŠ¥ ê±´ìˆ˜ : ${pad4(v)}ê±´)`;
    elCreditMeter.textContent = txt;
    elCreditMeter2.textContent = txt;
    const blocked = v <= 0;
    inputCamera.disabled = blocked;
    inputFile.disabled   = blocked;
    if (blocked) { img.classList.add('hidden'); btnAnalyze.classList.add('hidden'); }
  }

  // reset ì§€ì›
  (function initCredits(){
    const p = new URLSearchParams(location.search);
    if (p.has('reset')) localStorage.removeItem(LS_KEY_CREDITS);
    renderCredits();
  })();

  // íŒŒì¼ ì„ íƒ
  async function onFilePicked(file){
    if(!file) return;
    if(loadCredits()<=0){ alert('ì”ì—¬ ê±´ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤. ê´‘ê³  ì‹œì²­ìœ¼ë¡œ ì¶©ì „í•´ì£¼ì„¸ìš”.'); return; }
    img.src = URL.createObjectURL(file);
    img.classList.remove('hidden');
    btnAnalyze.classList.remove('hidden');
  }
  inputCamera.addEventListener('change', ()=> onFilePicked(inputCamera.files?.[0]));
  inputFile  .addEventListener('change', ()=> onFilePicked(inputFile.files?.[0]));

  // Base64
  const toBase64 = (file)=> new Promise((resolve)=>{
    const r = new FileReader();
    r.onload = ()=> resolve(r.result.split(',')[1]);
    r.readAsDataURL(file);
  });

  // ì¿ íŒ¡ ë§í¬
  function coupangAppUrl(q){ return 'coupang://search?q=' + encodeURIComponent(q); }
  function coupangWebUrl(q){
    const base='https://www.coupang.com/np/search';
    const params = new URLSearchParams({ q, channel:'user', lptag: PARTNER_ID, subId: SUB_ID });
    return `${base}?${params.toString()}`;
  }

  // ê²€ìƒ‰ í‚¤ì›Œë“œ ìƒì„±(ìš”ì•½ ê²°ê³¼ â†’ í‚¤ì›Œë“œ)
  function buildSearchKeyword(product={}, fallbackTitle=''){
    const parts = [];
    if (product.brand) parts.push(product.brand);
    if (product.model) parts.push(product.model);
    if (product.name)  parts.push(product.name);
    if (Array.isArray(product.attrs)) parts.push(...product.attrs.slice(0,3));
    let q = parts.join(' ').replace(/\s+/g,' ').trim();
    if (!q) q = (fallbackTitle||'').trim();
    if (q.length > 80) q = q.slice(0,80);
    return q;
  }

  // ì¿ íŒ¡ ë²„íŠ¼ ë¶€ì°©
  function attachCoupangButton(containerEl, keyword){
    // ê¸°ì¡´ ë²„íŠ¼ ì¤‘ë³µ ë°©ì§€
    const old = containerEl.querySelector('[data-coupang-btn]');
    if (old) old.remove();

    const wrap = document.createElement('div');
    wrap.style.marginTop='10px';
    const btn = document.createElement('button');
    btn.setAttribute('data-coupang-btn','1');
    btn.className = 'btn';
    btn.textContent = 'ğŸ›’ ì¿ íŒ¡ì—ì„œ ìµœì €ê°€ ë³´ê¸°';
    btn.addEventListener('click', ()=>{
      if(!keyword){ alert('ê²€ìƒ‰ í‚¤ì›Œë“œë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.'); return; }
      const appU = coupangAppUrl(keyword);
      const webU = coupangWebUrl(keyword);
      location.href = appU; // ì•± ìš°ì„ 
      setTimeout(()=> window.open(webU,'_blank','noopener,noreferrer'), 400); // ì›¹ í´ë°±
    });
    wrap.appendChild(btn);
    containerEl.appendChild(wrap);
  }

  // ë¶„ì„ ì‹¤í–‰
  btnAnalyze.addEventListener('click', async ()=>{
    const file = inputCamera.files?.[0] || inputFile.files?.[0];
    if(!file) return alert('ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
    if(loadCredits()<=0){ alert('ì”ì—¬ ê±´ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤. ê´‘ê³  ì‹œì²­ìœ¼ë¡œ ì¶©ì „í•´ì£¼ì„¸ìš”.'); return; }

    btnAnalyze.textContent = 'ì¸ì‹ ì¤‘...';
    btnAnalyze.disabled = true;

    try{
      // 1íšŒ ì°¨ê°
      saveCredits(loadCredits()-1);

      let data;
      if (USE_MOCK){
        // ëª¨ì˜ ì‘ë‹µ: ë°”ë¡œ ë™ì‘ í™•ì¸ìš©
        await new Promise(r=>setTimeout(r, 500));
        data = {
          success:true,
          payload:{
            product:{ brand:'ë¼ì½”ìŠ¤í…Œ', model:'L1212', name:'í´ë¡œ í‹°ì…”ì¸ ', attrs:['ë‚¨ì„±','ë°˜íŒ”','í™”ì´íŠ¸'] },
            coreSummary:'- ë¸Œëœë“œ: ë¼ì½”ìŠ¤í…Œ\n- ëª¨ë¸: L1212\n- ìœ í˜•: í´ë¡œ í‹°ì…”ì¸ \n- íŠ¹ì´ì‚¬í•­: ë©´ 100%, ê¸°ë³¸í•',
            categories:[
              { title:'ğŸ§¾ í•µì‹¬ìš”ì•½', summary:'- ì£¼ìš” ìŠ¤í™: ë©´ 100%, ê¸°ë³¸í•, ë°˜íŒ”\n- ì„¸íƒ: ì €ì˜¨/ì†ì„¸íƒ ê¶Œì¥\n- ê°€ê²© ì²´í¬: ì¿ íŒ¡ ìµœì €ê°€ í™•ì¸ ê¶Œì¥' },
              { title:'ğŸ‘• ì†Œì¬/ê´€ë¦¬', summary:'- ì†Œì¬: ë©´ 100%\n- ì„¸íƒ: ì°¬ë¬¼/ì¤‘ì„±ì„¸ì œ, ê±´ì¡°ê¸° ì§€ì–‘' }
            ]
          }
        };
      }else{
        const base64 = await toBase64(file);
        const r = await fetch(`${API_BASE}/api/summarize`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ imageBase64: base64, lang:'ko' })
        });
        data = await r.json();
        if(!data.success && !r.ok) throw new Error(data.message || 'ìš”ì•½ ì‹¤íŒ¨');
      }

      const payload = data.payload || { categories:[], coreSummary:'-' };
      window.lastPayload = payload;

      // ì¹´í…Œê³ ë¦¬ í‘œì‹œ
      renderCategories(payload);
      stepUpload.classList.add('hidden');
      stepCats.classList.remove('hidden');
      window.scrollTo({ top:0, behavior:'smooth' });

    }catch(e){
      alert(e.message || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }finally{
      btnAnalyze.textContent = 'ğŸ” ì‘ì€ ê¸€ì”¨ ìš”ì•½';
      btnAnalyze.disabled = false;
    }
  });

  function toBullets(text=''){
    const lines = (text||'').split('\n')
      .map(s=>s.trim()).filter(Boolean)
      .map(s=> s.startsWith('-')? s.slice(1).trim() : s);
    if(!lines.length) return '<ul class="bul"><li>-</li></ul>';
    return '<ul class="bul">' + lines.map(s=>`<li>${s}</li>`).join('') + '</ul>';
  }

  function renderCategories(payload){
    catsWrap.innerHTML = '';
    const list = payload.categories || [];
    list.forEach((c)=>{
      const b = document.createElement('button');
      b.className = 'btn block';
      b.textContent = c.title || '-';
      b.addEventListener('click', ()=> showAnswer(c.title, toBullets(c.summary), payload));
      catsWrap.appendChild(b);
    });
    // í•µì‹¬ìš”ì•½ ë²„íŠ¼(í•­ìƒ ì œê³µ)
    const coreBtn = document.createElement('button');
    coreBtn.className = 'btn secondary block';
    coreBtn.textContent = 'ğŸ§¾ í•µì‹¬ìš”ì•½';
    coreBtn.addEventListener('click', ()=> showAnswer('ğŸ§¾ í•µì‹¬ìš”ì•½', toBullets(payload.coreSummary || '-'), payload));
    catsWrap.appendChild(coreBtn);
  }

  function showAnswer(title, html, payload){
    answerTitle.textContent = title || 'ê²°ê³¼';
    answerBox.innerHTML = html || '<ul class="bul"><li>-</li></ul>';

    // ì¿ íŒ¡ ë²„íŠ¼ ë¶€ì°©
    const keyword = buildSearchKeyword(payload?.product || {}, title);
    attachCoupangButton(answerBox, keyword);

    stepCats.classList.add('hidden');
    stepAnswer.classList.remove('hidden');
    window.scrollTo({ top:0, behavior:'smooth' });
  }

  function resetAll(){
    inputCamera.value=''; inputFile.value='';
    img.src=''; img.classList.add('hidden');
    btnAnalyze.classList.add('hidden');
    stepAnswer.classList.add('hidden');
    stepCats.classList.add('hidden');
    stepUpload.classList.remove('hidden');
    renderCredits();
  }
  btnRetry1.addEventListener('click', resetAll);
  btnRetry2.addEventListener('click', resetAll);
  btnBack  .addEventListener('click', ()=>{
    stepAnswer.classList.add('hidden');
    stepCats.classList.remove('hidden');
    window.scrollTo({ top:0, behavior:'smooth' });
  });

  // ë¦¬ì›Œë“œ(ì‹œë®¬): +1
  btnReward.addEventListener('click', ()=>{
    saveCredits(loadCredits()+1);
    alert('ê´‘ê³  ì‹œì²­ ì™„ë£Œ! 1íšŒ ì¶©ì „ë˜ì—ˆìŠµë‹ˆë‹¤.');
  });
</script>
</body>
</html>
