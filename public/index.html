<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>👀 BigEyes · 사진 요약 + 쿠팡 최저가</title>
  <meta name="theme-color" content="#0b1020"/>
  <style>
    :root { --bg:#0b1020; --card:#121833; --ink:#e8ecff; --muted:#9aa5d1; --accent:#7aa2ff; --line:#223066; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--ink);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, Apple SD Gothic Neo, Malgun Gothic, sans-serif;
      background:
        radial-gradient(1200px 800px at 75% -10%, rgba(122,162,255,.18), transparent 60%),
        radial-gradient(900px 600px at 10% 10%, rgba(122,162,255,.10), transparent 55%),
        linear-gradient(180deg, #0b1020 0%, #070b17 100%),
        repeating-linear-gradient(45deg, rgba(255,255,255,0.03) 0px, rgba(255,255,255,0.03) 1px, transparent 1px, transparent 11px),
        repeating-linear-gradient(135deg, rgba(255,255,255,0.02) 0px, rgba(255,255,255,0.02) 1px, transparent 1px, transparent 11px);
      background-blend-mode: screen, screen, normal, overlay, overlay;
    }
    header{
      padding:18px; border-bottom:1px solid var(--line);
      position:sticky; top:0; z-index:10;
      background:rgba(11,16,32,.55); backdrop-filter:blur(6px);
      text-align:center;
    }
    h1{margin:0; font-size:22px; font-weight:800; display:flex; align-items:center; justify-content:center; gap:8px}
    main{max-width:900px; margin:0 auto; padding:16px; display:grid; gap:14px}
    .card{background:rgba(18,24,51,.92); border:1px solid var(--line); border-radius:16px; padding:16px; box-shadow:0 10px 40px rgba(0,0,0,.35)}
    .lead{font-size:16px; line-height:1.9; text-align:center}
    .credit{font-weight:700; color:#b9c8ff}
    .muted{color:var(--muted)}
    .row{display:grid; gap:10px}
    .grid2{display:grid; gap:10px; grid-template-columns:repeat(2,1fr)}
    .btn{display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:14px 16px; border-radius:14px; background:#1a2a6b; color:#fff; border:1px solid #3350aa; cursor:pointer; font-weight:700; font-size:17px}
    .btn.secondary{background:#0e1430; border-color:#2a3a7a; color:#c9d3ff; font-weight:600}
    .btn.block{width:100%}
    .btn[disabled]{opacity:.55; cursor:not-allowed}
    input[type="file"]{display:none}
    .preview{width:100%; max-height:380px; object-fit:contain; border-radius:12px; border:1px solid var(--line)}
    .hidden{display:none}
    .answer{white-space:pre-wrap; line-height:1.85; font-size:18px}
    .bul{margin:0; padding-left:1.1em} .bul li{margin:.25em 0}
    .banner-ad{margin-top:10px; border:1px dashed var(--line); border-radius:12px; padding:12px; text-align:center; color:#9fb1ff; background:#101738}
  </style>
</head>
<body>
<header>
  <h1>👀 BigEyes · 사진 요약 + 쿠팡 최저가</h1>
</header>

<main>
  <!-- 인트로 -->
  <section class="card">
    <div class="lead">
      <strong>사진 속 작은 글씨를 한눈에 요약</strong><br/>
      그리고 추출한 키워드로 <strong>쿠팡 최저가 바로가기</strong>까지!
    </div>
    <p class="center" style="margin:8px 0 0; text-align:center">
      <span id="creditMeter" class="credit">(이용 가능 건수 : 0000건)</span>
    </p>
    <p class="center" style="margin:8px 0 0; font-size:13px; text-align:center">
      <a href="/privacy.html">개인정보처리방침</a> · <a href="/terms.html">이용약관</a>
    </p>
  </section>

  <!-- STEP 1: 업로드 -->
  <section id="step-upload" class="card">
    <div class="row" style="grid-template-columns:1fr auto; align-items:center">
      <h2 style="margin:0">1) 사진 선택</h2>
      <div class="credit" id="creditMeter2"></div>
    </div>

    <div class="row">
      <label class="btn block">
        📷 카메라로 찍기
        <input id="inputCamera" type="file" accept="image/*" capture="environment">
      </label>
      <label class="btn block">
        📁 파일에서 선택
        <input id="inputFile" type="file" accept="image/*">
      </label>
    </div>

    <img id="img" class="preview hidden" alt="preview"/>
    <div style="height:10px"></div>
    <button id="btnAnalyze" class="btn hidden">🔍 작은 글씨 요약</button>

    <div class="banner-ad">배너 광고 영역 (플레이스홀더)</div>
  </section>

  <!-- STEP 2: 카테고리 -->
  <section id="step-categories" class="card hidden">
    <h2 style="margin:0 0 8px">2) 카테고리 선택</h2>
    <div id="cats" class="row"></div>
    <div style="height:10px"></div>
    <button id="btnRetry1" class="btn secondary">↻ 다시 찍기</button>
  </section>

  <!-- STEP 3: 결과 -->
  <section id="step-answer" class="card hidden">
    <h2 id="answerTitle" style="margin:0 0 6px"></h2>
    <div id="answer" class="answer"></div>
    <!-- 쿠팡 버튼이 여기 붙습니다 -->
    <div style="height:12px"></div>
    <div class="grid2">
      <button id="btnBack" class="btn secondary">⬅ 카테고리로 돌아가기</button>
      <button id="btnRetry2" class="btn secondary">↻ 다시 찍기</button>
    </div>
  </section>

  <!-- 보상형 광고 -->
  <section class="card">
    <h3 style="margin:0 0 6px">🎁 보상형 광고</h3>
    <p class="muted" style="margin:0 0 8px">광고를 시청하면 이용 가능 건수가 <strong>1회</strong> 충전됩니다.</p>
    <button id="btnReward" class="btn">광고 보고 1회 충전</button>
    <div id="rewardContainer" class="muted" style="margin-top:8px">리워드 광고 영역 (플레이스홀더)</div>
  </section>
</main>

<script>
  // ===== 설정 =====
  // API 서버 주소 (비우면 Mock로 동작해 바로 테스트 가능)
  const API_BASE = ''; // 예: 'https://your-server.com'
  const USE_MOCK = !API_BASE;

  // 크레딧(건수)
  const MAX_CREDITS = 9999;
  const DEFAULT_CREDITS = 3;
  const LS_KEY_CREDITS = 'be_credits_v08';

  // 쿠팡 파트너스
  const PARTNER_ID = 'AF2974050';
  const SUB_ID     = 'bigeyes';

  // ===== 유틸 =====
  const $ = (id)=>document.getElementById(id);
  const elCreditMeter  = $('creditMeter');
  const elCreditMeter2 = $('creditMeter2');
  const stepUpload = $('step-upload');
  const stepCats   = $('step-categories');
  const stepAnswer = $('step-answer');
  const inputCamera = $('inputCamera');
  const inputFile   = $('inputFile');
  const img         = $('img');
  const btnAnalyze  = $('btnAnalyze');
  const catsWrap    = $('cats');
  const answerBox   = $('answer');
  const answerTitle = $('answerTitle');
  const btnReward   = $('btnReward');
  const btnBack     = $('btnBack');
  const btnRetry1   = $('btnRetry1');
  const btnRetry2   = $('btnRetry2');

  function clamp(n, lo, hi){ return Math.max(lo, Math.min(hi, n)); }
  function pad4(n){ return String(n).padStart(4,'0'); }

  function loadCredits(){
    const n = parseInt(localStorage.getItem(LS_KEY_CREDITS) || `${DEFAULT_CREDITS}`, 10);
    return clamp(Number.isFinite(n) ? n : DEFAULT_CREDITS, 0, MAX_CREDITS);
  }
  function saveCredits(n){
    const v = clamp(n, 0, MAX_CREDITS);
    localStorage.setItem(LS_KEY_CREDITS, String(v));
    renderCredits(v);
    return v;
  }
  function renderCredits(v = loadCredits()){
    const txt = `(이용 가능 건수 : ${pad4(v)}건)`;
    elCreditMeter.textContent = txt;
    elCreditMeter2.textContent = txt;
    const blocked = v <= 0;
    inputCamera.disabled = blocked;
    inputFile.disabled   = blocked;
    if (blocked) { img.classList.add('hidden'); btnAnalyze.classList.add('hidden'); }
  }

  // reset 지원
  (function initCredits(){
    const p = new URLSearchParams(location.search);
    if (p.has('reset')) localStorage.removeItem(LS_KEY_CREDITS);
    renderCredits();
  })();

  // 파일 선택
  async function onFilePicked(file){
    if(!file) return;
    if(loadCredits()<=0){ alert('잔여 건수가 없습니다. 광고 시청으로 충전해주세요.'); return; }
    img.src = URL.createObjectURL(file);
    img.classList.remove('hidden');
    btnAnalyze.classList.remove('hidden');
  }
  inputCamera.addEventListener('change', ()=> onFilePicked(inputCamera.files?.[0]));
  inputFile  .addEventListener('change', ()=> onFilePicked(inputFile.files?.[0]));

  // Base64
  const toBase64 = (file)=> new Promise((resolve)=>{
    const r = new FileReader();
    r.onload = ()=> resolve(r.result.split(',')[1]);
    r.readAsDataURL(file);
  });

  // 쿠팡 링크
  function coupangAppUrl(q){ return 'coupang://search?q=' + encodeURIComponent(q); }
  function coupangWebUrl(q){
    const base='https://www.coupang.com/np/search';
    const params = new URLSearchParams({ q, channel:'user', lptag: PARTNER_ID, subId: SUB_ID });
    return `${base}?${params.toString()}`;
  }

  // 검색 키워드 생성(요약 결과 → 키워드)
  function buildSearchKeyword(product={}, fallbackTitle=''){
    const parts = [];
    if (product.brand) parts.push(product.brand);
    if (product.model) parts.push(product.model);
    if (product.name)  parts.push(product.name);
    if (Array.isArray(product.attrs)) parts.push(...product.attrs.slice(0,3));
    let q = parts.join(' ').replace(/\s+/g,' ').trim();
    if (!q) q = (fallbackTitle||'').trim();
    if (q.length > 80) q = q.slice(0,80);
    return q;
  }

  // 쿠팡 버튼 부착
  function attachCoupangButton(containerEl, keyword){
    // 기존 버튼 중복 방지
    const old = containerEl.querySelector('[data-coupang-btn]');
    if (old) old.remove();

    const wrap = document.createElement('div');
    wrap.style.marginTop='10px';
    const btn = document.createElement('button');
    btn.setAttribute('data-coupang-btn','1');
    btn.className = 'btn';
    btn.textContent = '🛒 쿠팡에서 최저가 보기';
    btn.addEventListener('click', ()=>{
      if(!keyword){ alert('검색 키워드를 찾지 못했습니다.'); return; }
      const appU = coupangAppUrl(keyword);
      const webU = coupangWebUrl(keyword);
      location.href = appU; // 앱 우선
      setTimeout(()=> window.open(webU,'_blank','noopener,noreferrer'), 400); // 웹 폴백
    });
    wrap.appendChild(btn);
    containerEl.appendChild(wrap);
  }

  // 분석 실행
  btnAnalyze.addEventListener('click', async ()=>{
    const file = inputCamera.files?.[0] || inputFile.files?.[0];
    if(!file) return alert('이미지를 선택하세요.');
    if(loadCredits()<=0){ alert('잔여 건수가 없습니다. 광고 시청으로 충전해주세요.'); return; }

    btnAnalyze.textContent = '인식 중...';
    btnAnalyze.disabled = true;

    try{
      // 1회 차감
      saveCredits(loadCredits()-1);

      let data;
      if (USE_MOCK){
        // 모의 응답: 바로 동작 확인용
        await new Promise(r=>setTimeout(r, 500));
        data = {
          success:true,
          payload:{
            product:{ brand:'라코스테', model:'L1212', name:'폴로 티셔츠', attrs:['남성','반팔','화이트'] },
            coreSummary:'- 브랜드: 라코스테\n- 모델: L1212\n- 유형: 폴로 티셔츠\n- 특이사항: 면 100%, 기본핏',
            categories:[
              { title:'🧾 핵심요약', summary:'- 주요 스펙: 면 100%, 기본핏, 반팔\n- 세탁: 저온/손세탁 권장\n- 가격 체크: 쿠팡 최저가 확인 권장' },
              { title:'👕 소재/관리', summary:'- 소재: 면 100%\n- 세탁: 찬물/중성세제, 건조기 지양' }
            ]
          }
        };
      }else{
        const base64 = await toBase64(file);
        const r = await fetch(`${API_BASE}/api/summarize`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ imageBase64: base64, lang:'ko' })
        });
        data = await r.json();
        if(!data.success && !r.ok) throw new Error(data.message || '요약 실패');
      }

      const payload = data.payload || { categories:[], coreSummary:'-' };
      window.lastPayload = payload;

      // 카테고리 표시
      renderCategories(payload);
      stepUpload.classList.add('hidden');
      stepCats.classList.remove('hidden');
      window.scrollTo({ top:0, behavior:'smooth' });

    }catch(e){
      alert(e.message || '오류가 발생했습니다.');
    }finally{
      btnAnalyze.textContent = '🔍 작은 글씨 요약';
      btnAnalyze.disabled = false;
    }
  });

  function toBullets(text=''){
    const lines = (text||'').split('\n')
      .map(s=>s.trim()).filter(Boolean)
      .map(s=> s.startsWith('-')? s.slice(1).trim() : s);
    if(!lines.length) return '<ul class="bul"><li>-</li></ul>';
    return '<ul class="bul">' + lines.map(s=>`<li>${s}</li>`).join('') + '</ul>';
  }

  function renderCategories(payload){
    catsWrap.innerHTML = '';
    const list = payload.categories || [];
    list.forEach((c)=>{
      const b = document.createElement('button');
      b.className = 'btn block';
      b.textContent = c.title || '-';
      b.addEventListener('click', ()=> showAnswer(c.title, toBullets(c.summary), payload));
      catsWrap.appendChild(b);
    });
    // 핵심요약 버튼(항상 제공)
    const coreBtn = document.createElement('button');
    coreBtn.className = 'btn secondary block';
    coreBtn.textContent = '🧾 핵심요약';
    coreBtn.addEventListener('click', ()=> showAnswer('🧾 핵심요약', toBullets(payload.coreSummary || '-'), payload));
    catsWrap.appendChild(coreBtn);
  }

  function showAnswer(title, html, payload){
    answerTitle.textContent = title || '결과';
    answerBox.innerHTML = html || '<ul class="bul"><li>-</li></ul>';

    // 쿠팡 버튼 부착
    const keyword = buildSearchKeyword(payload?.product || {}, title);
    attachCoupangButton(answerBox, keyword);

    stepCats.classList.add('hidden');
    stepAnswer.classList.remove('hidden');
    window.scrollTo({ top:0, behavior:'smooth' });
  }

  function resetAll(){
    inputCamera.value=''; inputFile.value='';
    img.src=''; img.classList.add('hidden');
    btnAnalyze.classList.add('hidden');
    stepAnswer.classList.add('hidden');
    stepCats.classList.add('hidden');
    stepUpload.classList.remove('hidden');
    renderCredits();
  }
  btnRetry1.addEventListener('click', resetAll);
  btnRetry2.addEventListener('click', resetAll);
  btnBack  .addEventListener('click', ()=>{
    stepAnswer.classList.add('hidden');
    stepCats.classList.remove('hidden');
    window.scrollTo({ top:0, behavior:'smooth' });
  });

  // 리워드(시뮬): +1
  btnReward.addEventListener('click', ()=>{
    saveCredits(loadCredits()+1);
    alert('광고 시청 완료! 1회 충전되었습니다.');
  });
</script>
</body>
</html>
