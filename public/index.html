<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BigEyes Â· ì‚¬ì§„ ìš”ì•½ + ì¿ íŒ¡ ìµœì €ê°€</title>
<meta name="theme-color" content="#0b1020"/>
<style>
:root { --bg:#0b1020; --card:#121833; --ink:#e8ecff; --muted:#9aa5d1; --accent:#7aa2ff; --line:#223066; }
*{box-sizing:border-box}
body{margin:0;color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Apple SD Gothic Neo,Malgun Gothic,sans-serif;background:#0b1020}
header{position:sticky;top:0;padding:16px;border-bottom:1px solid var(--line);background:#0b1020cc;backdrop-filter:blur(6px);text-align:center}
h1{margin:0;font-size:20px}
main{max-width:900px;margin:0 auto;padding:16px;display:grid;gap:14px}
.card{background:#121833e8;border:1px solid var(--line);border-radius:16px;padding:16px}
.lead{text-align:center;line-height:1.8}
.credit{font-weight:700;color:#b9c8ff}
.row{display:grid;gap:10px}
.grid2{display:grid;gap:10px;grid-template-columns:repeat(2,1fr)}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:14px 16px;border-radius:14px;background:#1a2a6b;border:1px solid #3350aa;color:#fff;font-weight:700;cursor:pointer}
.btn.secondary{background:#0e1430;border-color:#2a3a7a;color:#c9d3ff}
.btn[disabled]{opacity:.5;cursor:not-allowed}
input[type="file"]{display:none}
input[type="text"]{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #2a3a7a;background:#0e1430;color:#e8ecff}
.preview{width:100%;max-height:380px;object-fit:contain;border-radius:12px;border:1px solid var(--line)}
.hidden{display:none}
.answer{white-space:pre-wrap;line-height:1.85}
.small{font-size:13px;color:var(--muted)}
.section-title{margin:0 0 6px}
</style>
</head>
<body>
<header><h1>ğŸ‘€ BigEyes Â· ì‚¬ì§„ ìš”ì•½ + ì¿ íŒ¡ ìµœì €ê°€</h1></header>

<main>
  <!-- ì¸íŠ¸ë¡œ -->
  <section class="card">
    <div class="lead">
      <strong>ì‚¬ì§„ ì† ì‘ì€ ê¸€ì”¨ ìš”ì•½</strong> + <strong>ì¿ íŒ¡ ìµœì €ê°€ ë°”ë¡œê°€ê¸°</strong><br/>
      ìë™ ì¶”ì¶œëœ ê²€ìƒ‰ì–´ëŠ” <em>ìˆ˜ì • ê°€ëŠ¥</em>í•´ìš”.
    </div>
    <p style="text-align:center;margin:8px 0 0">
      <span id="creditTop" class="credit">(ì´ìš© ê°€ëŠ¥ ê±´ìˆ˜ : 0000ê±´)</span>
    </p>
  </section>

  <!-- STEP 1: ì—…ë¡œë“œ -->
  <section id="stepUpload" class="card">
    <div class="row" style="grid-template-columns:1fr auto;align-items:center">
      <h2 class="section-title">1) ì‚¬ì§„ ì„ íƒ</h2>
      <div id="creditTop2" class="credit"></div>
    </div>

    <div class="row">
      <label class="btn">
        ğŸ“· ì¹´ë©”ë¼ë¡œ ì°ê¸°
        <input id="fileCam" type="file" accept="image/*" capture="environment">
      </label>
      <label class="btn">
        ğŸ“ íŒŒì¼ì—ì„œ ì„ íƒ
        <input id="filePick" type="file" accept="image/*">
      </label>
    </div>

    <img id="imgPrev" class="preview hidden" alt="preview"/>

    <!-- ì•¡ì…˜: ë‘ ì„ íƒì§€ -->
    <div class="grid2" style="margin-top:8px">
      <button id="btnAnalyze" class="btn hidden">ğŸ” ì‘ì€ ê¸€ì”¨ ìš”ì•½</button>
      <button id="btnCoupangFlow" class="btn secondary hidden">ğŸ›’ ì¿ íŒ¡ ìµœì €ê°€ ê°€ê¸°</button>
    </div>
    <p class="small">â€» ê°™ì€ ì‚¬ì§„ì— ëŒ€í•´ OCRì€ í•œ ë²ˆë§Œ ì°¨ê°ë©ë‹ˆë‹¤.</p>
  </section>

  <!-- STEP 2-A: ì¹´í…Œê³ ë¦¬/ìš”ì•½ ê²°ê³¼(ê¸°ì¡´) -->
  <section id="stepCats" class="card hidden">
    <h2 class="section-title">2) ì¹´í…Œê³ ë¦¬ ì„ íƒ</h2>
    <div id="cats" class="row"></div>
    <div style="height:8px"></div>
    <button id="btnBack1" class="btn secondary">â†» ë‹¤ì‹œ ì°ê¸°</button>
  </section>

  <!-- STEP 2-B: ì¿ íŒ¡ í‚¤ì›Œë“œ ìˆ˜ì • ì„¹ì…˜ -->
  <section id="stepCoupang" class="card hidden">
    <h2 class="section-title">2) ì¿ íŒ¡ ê²€ìƒ‰ í‚¤ì›Œë“œ í™•ì¸/ìˆ˜ì •</h2>
    <div class="row">
      <input id="kwBrand" type="text" placeholder="ë¸Œëœë“œ (ì˜ˆ: ë¼ì½”ìŠ¤í…Œ)">
      <input id="kwModel" type="text" placeholder="ëª¨ë¸ (ì˜ˆ: L1212)">
      <input id="kwName"  type="text" placeholder="ì œí’ˆëª… (ì˜ˆ: í´ë¡œ í‹°ì…”ì¸ )">
      <input id="kwAttrs" type="text" placeholder="ì†ì„± (ì˜ˆ: ë‚¨ì„±, ë°˜íŒ”, í™”ì´íŠ¸)">
      <input id="kwFinal" type="text" placeholder="ìµœì¢… ê²€ìƒ‰ì–´ (ìë™ ìƒì„±/ìˆ˜ì • ê°€ëŠ¥)">
      <div class="grid2">
        <button id="btnMakeKW" class="btn secondary">ğŸ”§ ê²€ìƒ‰ì–´ ìë™ êµ¬ì„±</button>
        <button id="btnGoCoupang" class="btn">ğŸ›’ ìµœì €ê°€ ë³´ëŸ¬ê°€ê¸°</button>
      </div>
      <button id="btnBack2" class="btn secondary">â¬… ì‚¬ì§„ í™”ë©´ìœ¼ë¡œ</button>
    </div>
  </section>

  <!-- ë³´ìƒí˜• ê´‘ê³ ë§Œ ìœ ì§€ -->
  <section class="card">
    <h3 class="section-title">ğŸ ë³´ìƒí˜• ê´‘ê³ </h3>
    <p class="small">ê´‘ê³ ë¥¼ ì‹œì²­í•˜ë©´ ì´ìš© ê°€ëŠ¥ ê±´ìˆ˜ê°€ <strong>1íšŒ</strong> ì¶©ì „ë©ë‹ˆë‹¤.</p>
    <button id="btnReward" class="btn">ê´‘ê³  ë³´ê³  1íšŒ ì¶©ì „</button>
  </section>
</main>

<script>
// ====== ì„¤ì • ======
const API_BASE = '';                 // ì„œë²„ ë„£ìœ¼ë©´ ì‹¤ì œ ìš”ì•½, ë¹„ìš°ë©´ Mock
const USE_MOCK = !API_BASE;

const PARTNER_ID = 'AF2974050';      // ì¿ íŒ¡ íŒŒíŠ¸ë„ˆìŠ¤
const SUB_ID     = 'bigeyes';

const LS_KEY = 'be_credits_v08';
const DEFAULT_CREDITS = 3;
const MAX_CREDITS = 9999;

// ====== ìƒíƒœ ======
let lastImageBlob = null;
let lastOCR = null;        // { product:{brand,model,name,attrs[]}, coreSummary, categories[] }
let ocrDoneForThisImage = false; // ê°™ì€ ì´ë¯¸ì§€ë©´ OCR 1íšŒë§Œ ì°¨ê°

// ====== ìš”ì†Œ ======
const $ = id => document.getElementById(id);
const creditTop = $('creditTop'), creditTop2 = $('creditTop2');
const stepUpload=$('stepUpload'), stepCats=$('stepCats'), stepCoupang=$('stepCoupang');
const fileCam=$('fileCam'), filePick=$('filePick'), imgPrev=$('imgPrev');
const btnAnalyze=$('btnAnalyze'), btnCoupangFlow=$('btnCoupangFlow');
const catsBox=$('cats'), btnBack1=$('btnBack1'), btnBack2=$('btnBack2');
const kwBrand=$('kwBrand'), kwModel=$('kwModel'), kwName=$('kwName'), kwAttrs=$('kwAttrs'), kwFinal=$('kwFinal');
const btnMakeKW=$('btnMakeKW'), btnGoCoupang=$('btnGoCoupang');
const btnReward=$('btnReward');

// ====== í¬ë ˆë”§ ======
function clamp(n,lo,hi){return Math.max(lo,Math.min(hi,n))}
function pad4(n){return String(n).padStart(4,'0')}
function loadCredits(){const n=parseInt(localStorage.getItem(LS_KEY) || `${DEFAULT_CREDITS}`,10);return clamp(Number.isFinite(n)?n:DEFAULT_CREDITS,0,MAX_CREDITS)}
function saveCredits(n){const v=clamp(n,0,MAX_CREDITS);localStorage.setItem(LS_KEY,String(v));renderCredits(v)}
function renderCredits(v=loadCredits()){
  const txt=`(ì´ìš© ê°€ëŠ¥ ê±´ìˆ˜ : ${pad4(v)}ê±´)`;
  creditTop.textContent=txt; creditTop2.textContent=txt;
  const blocked = v<=0;
  fileCam.disabled=blocked; filePick.disabled=blocked;
}
(function initCredits(){
  const p=new URLSearchParams(location.search);
  if(p.has('reset')) localStorage.removeItem(LS_KEY);
  renderCredits();
})();

// ====== ê³µí†µ ìœ í‹¸ ======
function toBase64(file){return new Promise(res=>{const r=new FileReader();r.onload=()=>res(r.result.split(',')[1]);r.readAsDataURL(file);});}
function coupangAppUrl(q){return 'coupang://search?q='+encodeURIComponent(q)}
function coupangWebUrl(q){const base='https://www.coupang.com/np/search';const params=new URLSearchParams({q,channel:'user',lptag:PARTNER_ID,subId:SUB_ID});return `${base}?${params.toString()}`}

function buildSearchKeyword(product={}, fallback=''){
  const parts=[];
  if(product.brand) parts.push(product.brand);
  if(product.model) parts.push(product.model);
  if(product.name)  parts.push(product.name);
  if(Array.isArray(product.attrs)) parts.push(...product.attrs.slice(0,3));
  let q=parts.join(' ').replace(/\s+/g,' ').trim();
  if(!q) q=(fallback||'').trim();
  if(q.length>80) q=q.slice(0,80);
  return q;
}

// ====== íŒŒì¼ ì„ íƒ ======
async function onPick(file){
  if(!file) return;
  if(loadCredits()<=0){ alert('ì”ì—¬ ê±´ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤. ê´‘ê³  ì‹œì²­ìœ¼ë¡œ ì¶©ì „í•´ì£¼ì„¸ìš”.'); return; }

  lastImageBlob = file;
  imgPrev.src = URL.createObjectURL(file);
  imgPrev.classList.remove('hidden');
  btnAnalyze.classList.remove('hidden');
  btnCoupangFlow.classList.remove('hidden');

  // ìƒˆ ì´ë¯¸ì§€ì´ë¯€ë¡œ OCR ë‹¤ì‹œ í•„ìš”
  ocrDoneForThisImage = false;
  lastOCR = null;

  // í™”ë©´ ìœ„ì¹˜ ìœ ì§€
}
fileCam.addEventListener('change', ()=> onPick(fileCam.files?.[0]));
filePick.addEventListener('change', ()=> onPick(filePick.files?.[0]));

// ====== OCR ì‹¤í–‰ (í•œ ë²ˆë§Œ ì°¨ê°) ======
async function ensureOCR(){
  if(!lastImageBlob) throw new Error('ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
  if(lastOCR) return lastOCR;

  // ì°¨ê°ì€ ì—¬ê¸°ì„œë§Œ
  if(!ocrDoneForThisImage){
    const cur = loadCredits();
    if(cur<=0) throw new Error('ì”ì—¬ ê±´ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.');
    saveCredits(cur-1);
    ocrDoneForThisImage = true;
  }

  if(USE_MOCK){
    await new Promise(r=>setTimeout(r,500));
    lastOCR = {
      product:{brand:'ë¼ì½”ìŠ¤í…Œ',model:'L1212',name:'í´ë¡œ í‹°ì…”ì¸ ',attrs:['ë‚¨ì„±','ë°˜íŒ”','í™”ì´íŠ¸']},
      coreSummary:'- ë¸Œëœë“œ: ë¼ì½”ìŠ¤í…Œ\n- ëª¨ë¸: L1212\n- ìœ í˜•: í´ë¡œ í‹°ì…”ì¸ \n- íŠ¹ì´ì‚¬í•­: ë©´ 100%, ê¸°ë³¸í•',
      categories:[
        {title:'ğŸ§¾ í•µì‹¬ìš”ì•½',summary:'- ë©´ 100%, ê¸°ë³¸í•, ë°˜íŒ”\n- ì„¸íƒ: ì €ì˜¨/ì†ì„¸íƒ ê¶Œì¥\n- ê°€ê²© ì²´í¬: ì¿ íŒ¡ ìµœì €ê°€ í™•ì¸ ê¶Œì¥'},
        {title:'ğŸ‘• ì†Œì¬/ê´€ë¦¬',summary:'- ì†Œì¬: ë©´ 100%\n- ì„¸íƒ: ì°¬ë¬¼/ì¤‘ì„±ì„¸ì œ, ê±´ì¡°ê¸° ì§€ì–‘'}
      ]
    };
    return lastOCR;
  } else {
    const base64 = await toBase64(lastImageBlob);
    const r = await fetch(`${API_BASE}/api/summarize`,{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({imageBase64:base64,lang:'ko'})
    });
    const data = await r.json();
    if(!r.ok || !data.success) throw new Error(data.message || 'ìš”ì•½ ì‹¤íŒ¨');
    lastOCR = data.payload;
    return lastOCR;
  }
}

// ====== â‘  ì‘ì€ ê¸€ì”¨ ìš”ì•½ (ê¸°ì¡´) ======
$('btnAnalyze').addEventListener('click', async ()=>{
  try{
    const payload = await ensureOCR();
    // ì¹´í…Œê³ ë¦¬ ë Œë”
    catsBox.innerHTML='';
    (payload.categories||[]).forEach(c=>{
      const b=document.createElement('button');
      b.className='btn'; b.textContent=c.title||'-';
      b.onclick=()=>alert((c.summary||'-')); // ê°„ë‹¨ í‘œì‹œ(ì›ë˜ showAnswer ì‚¬ìš©í•´ë„ ë¨)
      catsBox.appendChild(b);
    });
    const core=document.createElement('button');
    core.className='btn secondary'; core.textContent='ğŸ§¾ í•µì‹¬ìš”ì•½';
    core.onclick=()=>alert(payload.coreSummary||'-');
    catsBox.appendChild(core);

    stepUpload.classList.add('hidden');
    stepCats.classList.remove('hidden');
    window.scrollTo({top:0,behavior:'smooth'});
  }catch(e){ alert(e.message||'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); }
});

// ====== â‘¡ ì¿ íŒ¡ í”Œë¡œìš°: OCR â†’ í¸ì§‘ â†’ ì´ë™ ======
$('btnCoupangFlow').addEventListener('click', async ()=>{
  try{
    const payload = await ensureOCR();
    // í¼ ì±„ìš°ê¸°
    kwBrand.value = payload.product?.brand || '';
    kwModel.value = payload.product?.model || '';
    kwName .value = payload.product?.name  || '';
    kwAttrs.value = (payload.product?.attrs||[]).join(', ');
    kwFinal.value = buildSearchKeyword(payload.product||{}, '');

    stepUpload.classList.add('hidden');
    stepCoupang.classList.remove('hidden');
    window.scrollTo({top:0,behavior:'smooth'});
  }catch(e){ alert(e.message||'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); }
});

// ìë™ êµ¬ì„±
btnMakeKW.addEventListener('click', ()=>{
  const attrs = kwAttrs.value.split(',').map(s=>s.trim()).filter(Boolean);
  const product = {brand:kwBrand.value.trim(), model:kwModel.value.trim(), name:kwName.value.trim(), attrs};
  kwFinal.value = buildSearchKeyword(product,'');
});

// ìµœì €ê°€ ë³´ëŸ¬ê°€ê¸°
btnGoCoupang.addEventListener('click', ()=>{
  const keyword = (kwFinal.value||'').trim();
  if(!keyword) return alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
  const appU=coupangAppUrl(keyword);
  const webU=coupangWebUrl(keyword);
  location.href=appU; setTimeout(()=>window.open(webU,'_blank','noopener,noreferrer'),400);
});

// ë’¤ë¡œê°€ê¸°ë“¤
btnBack1.addEventListener('click', ()=>{ resetToUpload(); });
btnBack2.addEventListener('click', ()=>{ stepCoupang.classList.add('hidden'); stepUpload.classList.remove('hidden'); });

// ë¦¬ì…‹
function resetToUpload(){
  fileCam.value=''; filePick.value='';
  imgPrev.src=''; imgPrev.classList.add('hidden');
  btnAnalyze.classList.add('hidden'); btnCoupangFlow.classList.add('hidden');
  lastImageBlob=null; lastOCR=null; ocrDoneForThisImage=false;
  stepCats.classList.add('hidden'); stepCoupang.classList.add('hidden'); stepUpload.classList.remove('hidden');
  renderCredits();
}

// ë³´ìƒí˜• ê´‘ê³ (+1)
btnReward.addEventListener('click', ()=>{ saveCredits(loadCredits()+1); alert('ê´‘ê³  ì‹œì²­ ì™„ë£Œ! 1íšŒ ì¶©ì „ë˜ì—ˆìŠµë‹ˆë‹¤.'); });

</script>
</body>
</html>
