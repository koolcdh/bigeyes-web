<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BigEyes Â· ì‚¬ì§„ ìš”ì•½ + ì¿ íŒ¡ ìµœì €ê°€ ë¹„êµ</title>
<meta name="theme-color" content="#0b1020"/>
<style>
:root { --bg:#0b1020; --card:#121833; --ink:#e8ecff; --muted:#9aa5d1; --accent:#7aa2ff; --line:#223066; }
*{box-sizing:border-box}
body{margin:0;color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Apple SD Gothic Neo,Malgun Gothic,sans-serif;background:#0b1020}
header{position:sticky;top:0;padding:16px;border-bottom:1px solid var(--line);background:#0b1020cc;backdrop-filter:blur(6px);text-align:center}
h1{margin:0;font-size:20px}
main{max-width:900px;margin:0 auto;padding:16px;display:grid;gap:14px}
.card{background:#121833e8;border:1px solid var(--line);border-radius:16px;padding:16px}
.lead{text-align:center;line-height:1.8}
.credit{font-weight:700;color:#b9c8ff}
.row{display:grid;gap:10px}
.grid2{display:grid;gap:10px;grid-template-columns:repeat(2,1fr)}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:14px 16px;border-radius:14px;background:#1a2a6b;border:1px solid #3350aa;color:#fff;font-weight:700;cursor:pointer}
.btn.secondary{background:#0e1430;border-color:#2a3a7a;color:#c9d3ff}
.btn[disabled]{opacity:.5;cursor:not-allowed}
input[type="file"]{display:none}
input[type="text"]{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #2a3a7a;background:#0e1430;color:#e8ecff}
textarea.summary-box{
  width:100%; min-height:220px; padding:12px 14px;
  border-radius:12px; border:1px solid #2a3a7a;
  background:#0e1430; color:#e8ecff; line-height:1.7; font-size:15px;
  white-space:pre-wrap; resize:vertical;
}
.preview{width:100%;max-height:380px;object-fit:contain;border-radius:12px;border:1px solid var(--line)}
.hidden{display:none}
.small{font-size:13px;color:var(--muted)}
.section-title{margin:0 0 6px}

/* ë¡œë”© ì˜¤ë²„ë ˆì´ */
#loadingOverlay{
  position:fixed; inset:0; display:none; place-items:center;
  background:rgba(6,10,25,.58); backdrop-filter: blur(6px); z-index:99;
}
#loadingOverlay.show{display:grid}
.loader{
  display:inline-flex; align-items:center; gap:10px;
  background:#121833; border:1px solid #223066; color:#e8ecff;
  padding:12px 18px; border-radius:12px; font-weight:700;
}
.loader-dot{width:8px;height:8px;border-radius:50%;background:#7aa2ff;animation:bounce .9s infinite ease-in-out}
.loader-dot:nth-child(2){animation-delay:.15s}
.loader-dot:nth-child(3){animation-delay:.3s}
@keyframes bounce{0%,80%,100%{transform:scale(0.8);opacity:.6}40%{transform:scale(1);opacity:1}}
</style>
</head>
<body>
<header><h1>ğŸ‘€ BigEyes Â· ì‚¬ì§„ ìš”ì•½ + ì¿ íŒ¡ ìµœì €ê°€</h1></header>

<!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
<div id="loadingOverlay" aria-live="polite" aria-busy="true">
  <div class="loader">
    <span class="loader-dot"></span><span class="loader-dot"></span><span class="loader-dot"></span>
    <span>ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤... ì ì‹œë§Œìš”</span>
  </div>
</div>

<main>
  <!-- ì¸íŠ¸ë¡œ -->
  <section class="card">
    <div class="lead">
      <strong>ì‚¬ì§„ ì† ì‘ì€ ê¸€ì”¨ ìš”ì•½</strong> + <strong>ì¿ íŒ¡ ìµœì €ê°€ ë°”ë¡œê°€ê¸°</strong><br/>
      ê°€ì… X ì´ìš©ì •ë³´ ì €ì¥ X í¸í•˜ê²Œ ì‚¬ìš©í•˜ì„¸ìš”
    </div>
    <p style="text-align:center;margin:8px 0 0">
      <span id="creditTop" class="credit">(ì´ìš© ê°€ëŠ¥ ê±´ìˆ˜ : 0000ê±´)</span>
    </p>
  </section>

  <!-- STEP 1: ì—…ë¡œë“œ -->
  <section id="stepUpload" class="card">
    <div class="row" style="grid-template-columns:1fr auto;align-items:center">
      <h2 class="section-title">1) ì‚¬ì§„ ì„ íƒ</h2>
      <div id="creditTop2" class="credit"></div>
    </div>

    <div class="row">
      <label class="btn">
        ğŸ“· ì¹´ë©”ë¼ë¡œ ì°ê¸°
        <input id="fileCam" type="file" accept="image/*" capture="environment">
      </label>
      <label class="btn">
        ğŸ“ íŒŒì¼ì—ì„œ ì„ íƒ
        <input id="filePick" type="file" accept="image/*">
      </label>
    </div>

    <img id="imgPrev" class="preview hidden" alt="preview"/>

    <!-- ì•¡ì…˜: ë‘ ì„ íƒì§€ -->
    <div class="grid2" style="margin-top:8px">
      <button id="btnAnalyze" class="btn hidden">ğŸ” ì‘ì€ ê¸€ì”¨ ìš”ì•½</button>
      <button id="btnCoupangFlow" class="btn secondary hidden">ğŸ›’ ì¿ íŒ¡ ìµœì €ê°€ ê°€ê¸°</button>
    </div>
    <p class="small">â€» ê°™ì€ ì‚¬ì§„ì— ëŒ€í•´ OCRì€ í•œ ë²ˆë§Œ ì°¨ê°ë©ë‹ˆë‹¤.</p>
  </section>

  <!-- STEP 2-A: ë³´ê³ ì„œ í˜•íƒœ ìš”ì•½(ì½ê¸° ì „ìš©) -->
  <section id="stepSummary" class="card hidden">
    <h2 class="section-title">2) ìš”ì•½ ê²°ê³¼(ë³´ê³ ì„œ)</h2>
    <textarea id="sumReadOnly" class="summary-box" readonly></textarea>
    <div class="row" style="grid-template-columns:1fr;align-items:center">
      <!-- ìš”ì²­: ì´ í™”ë©´ì—ì„œëŠ” ìµœì €ê°€ ë²„íŠ¼ì„ ë…¸ì¶œí•˜ì§€ ì•ŠìŒ -->
      <button id="btnBackSum" class="btn secondary">â¬… ì´ì „ í™”ë©´ìœ¼ë¡œ</button>
    </div>
    <p class="small">â€» ìµœì €ê°€ ì´ë™ì€ ë‹¤ìŒ í™”ë©´(ê²€ìƒ‰ì–´ í™•ì¸ ë‹¨ê³„)ì—ì„œ ì§„í–‰í•  ìˆ˜ ìˆì–´ìš”.</p>
  </section>

  <!-- STEP 2-B: ì¿ íŒ¡ í‚¤ì›Œë“œ í™•ì¸/ìˆ˜ì • -->
  <section id="stepCoupang" class="card hidden">
    <h2 class="section-title">2) ì¿ íŒ¡ ê²€ìƒ‰ ì „ í™•ì¸</h2>
    <div class="row">
      <label><strong>ìš”ì•½ ë‚´ìš©</strong></label>
      <textarea id="sumBox" class="summary-box" readonly></textarea>
      <div class="grid2">
        <button id="btnEditSum" class="btn secondary">âœï¸ ìˆ˜ì •</button>
        <span class="small" style="align-self:center">â€» í•„ìš”í•  ë•Œë§Œ ìˆ˜ì •í•˜ì„¸ìš”.</span>
      </div>

      <label><strong>ê²€ìƒ‰ì–´</strong></label>
      <input id="kwFinal" type="text" placeholder="ì¿ íŒ¡ ê²€ìƒ‰ì–´" />

      <div class="grid2" style="margin-top:8px">
        <button id="btnBack2" class="btn secondary">â¬… ì´ì „ í™”ë©´ìœ¼ë¡œ</button>
        <button id="btnGoCoupang" class="btn">ğŸ›’ ìµœì €ê°€ ë³´ëŸ¬ê°€ê¸°</button>
      </div>
    </div>
  </section>

  <!-- ë³´ìƒí˜• ê´‘ê³ ë§Œ ìœ ì§€ -->
  <section class="card">
    <h3 class="section-title">ğŸ ë³´ìƒí˜• ê´‘ê³ </h3>
    <p class="small">ê´‘ê³ ë¥¼ ì‹œì²­í•˜ë©´ ì´ìš© ê°€ëŠ¥ ê±´ìˆ˜ê°€ <strong>1íšŒ</strong> ì¶©ì „ë©ë‹ˆë‹¤.</p>
    <button id="btnReward" class="btn">ê´‘ê³  ë³´ê³  1íšŒ ì¶©ì „</button>
  </section>
</main>

<script>
/* ===== ì„¤ì • ===== */
const API_BASE = window.location.origin;
const USE_MOCK = false; // ë§Œì•½ ì´ ë³€ìˆ˜ê°€ ìˆë‹¤ë©´ ê°•ì œë¡œ ì‹¤ì„œë²„ ëª¨ë“œ
const PARTNER_ID = 'AF2974050';      // ì¿ íŒ¡ íŒŒíŠ¸ë„ˆìŠ¤
const SUB_ID     = 'bigeyes';        // ì¶”ì  êµ¬ë¶„ì
const LS_KEY = 'be_credits_v08';
const DEFAULT_CREDITS = 3;
const MAX_CREDITS = 9999;

/* ===== ìƒíƒœ/ìš”ì†Œ ===== */
let lastImageBlob = null;
let lastOCR = null;                  // { product, coreSummary, categories[] ... }
let ocrDoneForThisImage = false;

const $ = id => document.getElementById(id);
const creditTop=$('creditTop'), creditTop2=$('creditTop2');
const stepUpload=$('stepUpload'), stepSummary=$('stepSummary'), stepCoupang=$('stepCoupang');
const fileCam=$('fileCam'), filePick=$('filePick'), imgPrev=$('imgPrev');
const btnAnalyze=$('btnAnalyze'), btnCoupangFlow=$('btnCoupangFlow');
const sumReadOnly=$('sumReadOnly'), btnBackSum=$('btnBackSum');
const sumBox=$('sumBox'), btnEditSum=$('btnEditSum'), kwFinal=$('kwFinal');
const btnBack2=$('btnBack2'), btnGoCoupang=$('btnGoCoupang');
const btnReward=$('btnReward');
const loadingOverlay=$('loadingOverlay');

/* ===== ë¡œë”© í† ê¸€ ===== */
function showLoading(on=true){
  loadingOverlay.classList[on? 'add':'remove']('show');
}

/* ===== í¬ë ˆë”§ ===== */
function clamp(n,lo,hi){return Math.max(lo,Math.min(hi,n))}
function pad4(n){return String(n).padStart(4,'0')}
function loadCredits(){const n=parseInt(localStorage.getItem(LS_KEY)||`${DEFAULT_CREDITS}`,10);return clamp(Number.isFinite(n)?n:DEFAULT_CREDITS,0,MAX_CREDITS)}
function saveCredits(n){const v=clamp(n,0,MAX_CREDITS);localStorage.setItem(LS_KEY,String(v));renderCredits(v)}
function renderCredits(v=loadCredits()){
  const txt=`(ì´ìš© ê°€ëŠ¥ ê±´ìˆ˜ : ${pad4(v)}ê±´)`;
  creditTop.textContent=txt; creditTop2.textContent=txt;
  const blocked=v<=0; fileCam.disabled=blocked; filePick.disabled=blocked;
}
(function initCredits(){const p=new URLSearchParams(location.search); if(p.has('reset')) localStorage.removeItem(LS_KEY); renderCredits();})();

/* ===== ìœ í‹¸ ===== */
// ì „ì†¡ ì „ ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ/ì••ì¶• (ê¸´ ë³€ 1600px, JPEG q=0.8)
async function toBase64(file, maxSide=1600, quality=0.8){
  const img = await new Promise(res=>{
    const i = new Image();
    i.onload = ()=>res(i);
    i.src = URL.createObjectURL(file);
  });
  const {width, height} = img;
  const scale = Math.min(1, maxSide / Math.max(width, height));
  const w = Math.round(width * scale), h = Math.round(height * scale);
  const canvas = document.createElement('canvas');
  canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(img, 0, 0, w, h);
  const dataUrl = canvas.toDataURL('image/jpeg', quality);
  return dataUrl.split(',')[1]; // base64ë§Œ ë°˜í™˜
}

function coupangAppUrl(q){return 'coupang://search?q='+encodeURIComponent(q)}
function coupangWebUrl(q){const base='https://www.coupang.com/np/search';const params=new URLSearchParams({q,channel:'user',lptag:PARTNER_ID,subId:SUB_ID});return `${base}?${params.toString()}`}
function buildSearchKeyword(product={}, fallback=''){
  const parts=[]; if(product.brand)parts.push(product.brand); if(product.model)parts.push(product.model); if(product.name)parts.push(product.name);
  if(Array.isArray(product.attrs)) parts.push(...product.attrs.slice(0,3));
  let q=parts.join(' ').replace(/\s+/g,' ').trim(); if(!q) q=(fallback||'').trim(); if(q.length>80) q=q.slice(0,80); return q;
}

// --- (ì¶”ê°€) ë³´ê³ ìš© ì „ì²´ í…ìŠ¤íŠ¸ í•©ì¹˜ê¸° ---
function gatherAllText(payload){
  const parts = [];
  if (payload.coreSummary) parts.push(payload.coreSummary);
  if (Array.isArray(payload.categories)){
    for(const c of payload.categories){
      if (c.title) parts.push(String(c.title));
      if (c.summary) parts.push(String(c.summary));
    }
  }
  return parts.join('\n');
}

// --- (ì¶”ê°€) ê°„ë‹¨ ë¸Œëœë“œ ì‚¬ì „(í•„ìš”ì‹œ í™•ì¥) ---
const BRAND_LIST = [
  'Lacoste','Nike','Adidas','Levi\'s','UNIQLO','Zara','H&M','Mango',
  'The North Face','Patagonia','Columbia','Ralph Lauren','Tommy Hilfiger'
];

// --- (ì¶”ê°€) í…ìŠ¤íŠ¸ì—ì„œ ì œí’ˆì½”ë“œ/ìƒ‰ìƒ/ì‚¬ì´ì¦ˆ/ë¸Œëœë“œ ì¶”ì¶œ ---
function extractInfo(textRaw=''){
  const text = String(textRaw||'').replace(/\n+/g,' ').trim();

  // 1) ì œí’ˆì½”ë“œ(ì /ëŒ€ì‹œ í—ˆìš©) â€” ì˜ˆ: HTR103.C00037, Cde: 02802
  let code = '';
  const codeRegs = [
    /Cde[:\s]*([A-Z0-9.\-]{3,})/i,
    /\b([A-Z]{2,}[A-Z0-9.\-]{2,})\b/g,
    /\b([A-Z0-9]{3,}\.[A-Z0-9.\-]{2,})\b/i
  ];
  for(const r of codeRegs){
    const m = r.exec(text);
    if(m && m[1]) { code = m[1]; break; }
  }
  if(code) code = code.replace(/\.+/g,' ').trim(); // HTR103.C00037 â†’ HTR103 C00037

  // 2) ìƒ‰ìƒ(ì˜/ë¶ˆ)
  const COLOR_WORDS = ['noir','black','blanc','white','gray','grey','navy','blue','bleu',
    'beige','brown','marron','red','rouge','green','vert','pink','rose','yellow','jaune',
    'gris','ivory','cream'];
  let color = '';
  for(const w of COLOR_WORDS){
    const m = new RegExp(`\\b${w}\\b`, 'i').exec(text);
    if(m){ color = m[0]; break; }
  }

  // 3) ì‚¬ì´ì¦ˆ(ë³´ê³ ì„œì—ëŠ” í‘œê¸°, ê²€ìƒ‰ì–´ì—ëŠ” ì œì™¸)
  let size = '';
  const sizeRegs = [
    /\bT\.?\s*(\d{2})\b/i,          // T. 32
    /\bsize\s*([A-Za-z0-9\-]+)\b/i, // size 32/size L
    /\bTaille\s*(\d{2})\b/i
  ];
  for(const r of sizeRegs){
    const m = r.exec(text);
    if(m && m[1]) { size = m[1]; break; }
  }

  // 4) ë¸Œëœë“œ(í…ìŠ¤íŠ¸ ì§ë§¤ì¹­)
  let brand = '';
  for(const b of BRAND_LIST){
    const re = new RegExp(`\\b${b.replace(/\s+/g,'\\s+')}`,'i');
    if(re.test(text)){ brand = b; break; }
  }
  return { code, color, size, brand };
}

// --- (ì¶”ê°€) í´ë°±: ìš”ì•½ í…ìŠ¤íŠ¸ì—ì„œ ì¼ë°˜ í‚¤ì›Œë“œ ì¶”ì¶œ(í•œêµ­ì–´/ì˜ë¬¸ í˜¼ìš© ë‹¨ìˆœ ê·œì¹™)
function extractGenericKeywords(textRaw='', max=4){
  const text = String(textRaw||'').toLowerCase().replace(/[^\wê°€-í£\s]/g,' ');
  const words = text.split(/\s+/).filter(Boolean);
  const stop = new Set(['the','and','for','with','this','that','size','color','black','white','gray','grey','noir','blanc','bleu','rouge','vert','jaune','of','to','in','on','a','an','mm','cm','inch','ì¸ì¹˜','ì‚¬ì´ì¦ˆ','ìƒ‰ìƒ','ì œí’ˆ','ëª¨ë¸','ì½”ë“œ']);
  const counts = new Map();
  for(const w of words){
    if (w.length<2 || stop.has(w)) continue;
    counts.set(w,(counts.get(w)||0)+1);
  }
  return [...counts.entries()].sort((a,b)=>b[1]-a[1]).slice(0,max).map(([w])=>w).join(' ');
}

/* ===== ë³´ê³ ì„œ ë Œë”ëŸ¬ ===== */
function buildReport(payload){
  const lines=[];
  const domain = payload.domain ? `(${payload.domain})` : '';

  // â–² ì œí’ˆ ì‹ë³„(ì½”ë“œ/ìƒ‰ìƒ/ì‚¬ì´ì¦ˆ/ë¸Œëœë“œ) â€” ì—†ìœ¼ë©´ 'ì •ë³´ ë¶€ì¡±/ì—†ìŒ'ìœ¼ë¡œ ëª…ì‹œ
  const info = extractInfo(gatherAllText(payload));
  lines.push(`ğŸ§¾ ì œí’ˆ ì‹ë³„ ${domain}`.trim());
  lines.push(` - ì œí’ˆì½”ë“œ: ${info.code || 'ì •ë³´ ë¶€ì¡±'}`);
  lines.push(` - ìƒ‰ìƒ: ${info.color || 'ì •ë³´ ë¶€ì¡±'}`);
  lines.push(` - ì‚¬ì´ì¦ˆ: ${info.size || 'ì •ë³´ ë¶€ì¡±'}`);
  lines.push(` - ë¸Œëœë“œ(ì¶”ì •): ${info.brand || 'ì—†ìŒ'}`);
  lines.push('');

  // â–¼ í•µì‹¬ ìš”ì•½
  const core = (payload.coreSummary||'').trim();
  if(core){
    lines.push('â–  í•µì‹¬ ìš”ì•½');
    for(const l of core.split('\n').filter(Boolean)){
      const t = l.replace(/^\-\s?/, '').trim();
      lines.push(' - ' + t);
    }
    lines.push('');
  }

  // â–¼ ì¹´í…Œê³ ë¦¬ ìš”ì•½
  const cats = Array.isArray(payload.categories)? payload.categories : [];
  for(const c of cats){
    const title = c.title || c.key || 'ì„¸ë¶€ì •ë³´';
    const sum = String(c.summary||'').trim();
    if(!sum) continue;
    lines.push(`â–  ${title}`);
    for(const l of sum.split('\n').filter(Boolean)){
      const t = l.replace(/^\-\s?/, '').trim();
      lines.push(' - ' + t);
    }
    lines.push('');
  }
  return lines.join('\n');
}

/* ===== OCR (í•œ ë²ˆë§Œ ì°¨ê°) ===== */
async function ensureOCR(){
  if(!lastImageBlob) throw new Error('ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
  if(lastOCR) return lastOCR;
  if(!ocrDoneForThisImage){ const cur=loadCredits(); if(cur<=0) throw new Error('ì”ì—¬ ê±´ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.'); saveCredits(cur-1); ocrDoneForThisImage=true; }
  if(USE_MOCK){
    await new Promise(r=>setTimeout(r,500));
    lastOCR={ 
      product:{brand:'ë¼ì½”ìŠ¤í…Œ',model:'L1212',name:'í´ë¡œ í‹°ì…”ì¸ ',attrs:['ë‚¨ì„±','ë°˜íŒ”','í™”ì´íŠ¸']},
      coreSummary:'- ë¸Œëœë“œ: ë¼ì½”ìŠ¤í…Œ\n- ëª¨ë¸: L1212\n- ìœ í˜•: í´ë¡œ í‹°ì…”ì¸ \n- íŠ¹ì´ì‚¬í•­: ë©´ 100%, ê¸°ë³¸í•',
      domain:'product_page',
      categories:[
        {key:'features', title:'âœ¨ í•µì‹¬íŠ¹ì§•', summary:'- ë©´ 100%\n- ê¸°ë³¸í•\n- ì¹´ë¼ ë””ìì¸'},
        {key:'price', title:'ğŸ’° ê°€ê²©Â·ì¡°ê±´', summary:'- ë³€ë™ ê°€ëŠ¥\n- ì¿ íŒ¡ì—ì„œ í™•ì¸'},
        {key:'warnings', title:'âš ï¸ ì£¼ì˜', summary:'- ì„¸íƒ ì‹œ ì£¼ì˜'}
      ]
    };
    return lastOCR;
  }else{
    const base64=await toBase64(lastImageBlob); // ë¦¬ì‚¬ì´ì¦ˆ/ì••ì¶• ì ìš©
    const r=await fetch(`${API_BASE}/api/summarize`,{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({imageBase64:base64,lang:'ko'})
    });
    let data;
    try{ data=await r.json(); }
    catch{
      const text=await r.text().catch(()=> '');
      if(r.status===413 || /Entity Too Large/i.test(text)) throw new Error('ì´ë¯¸ì§€ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤. ì‚¬ì§„ í•´ìƒë„ë¥¼ ë‚®ì¶”ê±°ë‚˜ ì••ì¶• í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.');
      throw new Error(text?.slice(0,120) || 'ì„œë²„ ì‘ë‹µì„ ì½ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
    }
    if(!r.ok || !data?.success) throw new Error(data?.message||'ìš”ì•½ ì‹¤íŒ¨');
    lastOCR=data.payload; 
    return lastOCR;
  }
}

/* ===== â‘  ì‘ì€ ê¸€ì”¨ ìš”ì•½ â†’ ë³´ê³ ì„œ í™”ë©´ ===== */
btnAnalyze.addEventListener('click', async ()=>{
  showLoading(true);
  try{
    const payload=await ensureOCR();
    sumReadOnly.value=buildReport(payload);
    stepUpload.classList.add('hidden'); 
    stepSummary.classList.remove('hidden'); 
    window.scrollTo({top:0,behavior:'smooth'});
  }catch(e){ 
    alert(e.message||'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); 
  }finally{
    showLoading(false);
  }
});
btnBackSum.addEventListener('click', ()=>{
  stepSummary.classList.add('hidden'); 
  stepUpload.classList.remove('hidden'); 
});

/* ===== â‘¡ ì¿ íŒ¡ í”Œë¡œìš°: ìš”ì•½ í•œ ì¹¸ + ê²€ìƒ‰ì–´ í•œ ì¤„ ===== */
btnCoupangFlow.addEventListener('click', async ()=>{
  showLoading(true);
  try{
    const payload=await ensureOCR();

    // ìš”ì•½ íŒ¨ë„ ì±„ìš°ê¸°
    const baseSummary=(payload.coreSummary||'').trim();
    const p=payload.product||{};
    const infoLine=[p.brand,p.model,p.name,Array.isArray(p.attrs)?p.attrs.slice(0,3).join(', '):''].filter(Boolean).join(' Â· ');
    $('sumBox').value=[baseSummary, infoLine?`\n\n[ì œí’ˆ] ${infoLine}`:''].join('');
    $('sumBox').readOnly=true; btnEditSum.textContent='âœï¸ ìˆ˜ì •';

    // ê²€ìƒ‰ì–´ ìƒì„±: (ë¸Œëœë“œ?) + ì½”ë“œ + ìƒ‰ìƒ  â†’ ëª¨ë‘ ì—†ìœ¼ë©´ core/catsì—ì„œ ì¼ë°˜ í‚¤ì›Œë“œ ì¶”ì¶œ
    let kw = buildSearchKeyword({ brand:p.brand, model:p.model, name:p.name, attrs:[] }, '').trim();
    if(!kw){
      const allText = gatherAllText(payload);
      const info = extractInfo(allText);
      const parts = [];
      if (info.brand) parts.push(info.brand);
      if (info.code)  parts.push(info.code);
      if (info.color) parts.push(info.color);
      kw = parts.join(' ').replace(/\s+/g,' ').trim();
      if(!kw){ kw = extractGenericKeywords(allText, 4); } // ìµœì¢… í´ë°±
    }
    kwFinal.value = kw;

    stepUpload.classList.add('hidden'); 
    stepCoupang.classList.remove('hidden'); 
    window.scrollTo({top:0,behavior:'smooth'});
  }catch(e){ 
    alert(e.message||'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); 
  }finally{
    showLoading(false);
  }
});

let isEditingSummary=false;
btnEditSum.addEventListener('click', ()=>{
  isEditingSummary=!isEditingSummary;
  sumBox.readOnly=!isEditingSummary;
  btnEditSum.textContent=isEditingSummary?'âœ… ìˆ˜ì • ì™„ë£Œ':'âœï¸ ìˆ˜ì •';
  if(!isEditingSummary){
    const firstLine=(sumBox.value||'').split('\n').map(s=>s.trim()).filter(Boolean)[0]||'';
    if(firstLine && !kwFinal.value.trim()) kwFinal.value=firstLine.slice(0,80);
  }
});

btnGoCoupang.addEventListener('click', ()=>{
  const keyword=(kwFinal.value||'').trim();
  if(!keyword) return alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
  const appU=coupangAppUrl(keyword), webU=coupangWebUrl(keyword);
  location.href=appU; setTimeout(()=>window.open(webU,'_blank','noopener,noreferrer'),400);
});

btnBack2.addEventListener('click', ()=>{ 
  stepCoupang.classList.add('hidden'); 
  stepUpload.classList.remove('hidden'); 
});

/* ===== ë³´ìƒí˜• ê´‘ê³ (+1) ===== */
btnReward.addEventListener('click', ()=>{ 
  saveCredits(loadCredits()+1); 
  alert('ê´‘ê³  ì‹œì²­ ì™„ë£Œ! 1íšŒ ì¶©ì „ë˜ì—ˆìŠµë‹ˆë‹¤.'); 
});
</script>
</body>
</html>
