<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BigEyes Â· ì‚¬ì§„ ìš”ì•½ + ì¿ íŒ¡ ìµœì €ê°€</title>
<meta name="theme-color" content="#0b1020"/>
<style>
:root { --bg:#0b1020; --card:#121833; --ink:#e8ecff; --muted:#9aa5d1; --accent:#7aa2ff; --line:#223066; }
*{box-sizing:border-box}
body{margin:0;color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Apple SD Gothic Neo,Malgun Gothic,sans-serif;background:#0b1020}
header{position:sticky;top:0;padding:16px;border-bottom:1px solid var(--line);background:#0b1020cc;backdrop-filter:blur(6px);text-align:center}
h1{margin:0;font-size:20px}
main{max-width:900px;margin:0 auto;padding:16px;display:grid;gap:14px}
.card{background:#121833e8;border:1px solid var(--line);border-radius:16px;padding:16px}
.lead{text-align:center;line-height:1.8}
.credit{font-weight:700;color:#b9c8ff}
.row{display:grid;gap:10px}
.grid2{display:grid;gap:10px;grid-template-columns:repeat(2,1fr)}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:14px 16px;border-radius:14px;background:#1a2a6b;border:1px solid #3350aa;color:#fff;font-weight:700;cursor:pointer}
.btn.secondary{background:#0e1430;border-color:#2a3a7a;color:#c9d3ff}
.btn[disabled]{opacity:.5;cursor:not-allowed}
input[type="file"]{display:none}
input[type="text"]{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #2a3a7a;background:#0e1430;color:#e8ecff}
textarea.summary-box{
  width:100%; min-height:160px; padding:12px 14px;
  border-radius:12px; border:1px solid #2a3a7a;
  background:#0e1430; color:#e8ecff; line-height:1.7; font-size:15px;
  resize:vertical;
}
.preview{width:100%;max-height:380px;object-fit:contain;border-radius:12px;border:1px solid var(--line)}
.hidden{display:none}
.small{font-size:13px;color:var(--muted)}
.section-title{margin:0 0 6px}
</style>
</head>
<body>
<header><h1>ğŸ‘€ BigEyes Â· ì‚¬ì§„ ìš”ì•½ + ì¿ íŒ¡ ìµœì €ê°€</h1></header>

<main>
  <!-- ì¸íŠ¸ë¡œ -->
  <section class="card">
    <div class="lead">
      <strong>ì‚¬ì§„ ì† ì‘ì€ ê¸€ì”¨ ìš”ì•½</strong> + <strong>ì¿ íŒ¡ ìµœì €ê°€ ë°”ë¡œê°€ê¸°</strong><br/>
      ìë™ ì¶”ì¶œëœ ê²€ìƒ‰ì–´ëŠ” í•„ìš”í•˜ë©´ <em>ìˆ˜ì •</em>í•˜ì„¸ìš”.
    </div>
    <p style="text-align:center;margin:8px 0 0">
      <span id="creditTop" class="credit">(ì´ìš© ê°€ëŠ¥ ê±´ìˆ˜ : 0000ê±´)</span>
    </p>
  </section>

  <!-- STEP 1: ì—…ë¡œë“œ -->
  <section id="stepUpload" class="card">
    <div class="row" style="grid-template-columns:1fr auto;align-items:center">
      <h2 class="section-title">1) ì‚¬ì§„ ì„ íƒ</h2>
      <div id="creditTop2" class="credit"></div>
    </div>

    <div class="row">
      <label class="btn">
        ğŸ“· ì¹´ë©”ë¼ë¡œ ì°ê¸°
        <input id="fileCam" type="file" accept="image/*" capture="environment">
      </label>
      <label class="btn">
        ğŸ“ íŒŒì¼ì—ì„œ ì„ íƒ
        <input id="filePick" type="file" accept="image/*">
      </label>
    </div>

    <img id="imgPrev" class="preview hidden" alt="preview"/>

    <!-- ì•¡ì…˜: ë‘ ì„ íƒì§€ -->
    <div class="grid2" style="margin-top:8px">
      <button id="btnAnalyze" class="btn hidden">ğŸ” ì‘ì€ ê¸€ì”¨ ìš”ì•½</button>
      <button id="btnCoupangFlow" class="btn secondary hidden">ğŸ›’ ì¿ íŒ¡ ìµœì €ê°€ ê°€ê¸°</button>
    </div>
    <p class="small">â€» ê°™ì€ ì‚¬ì§„ì— ëŒ€í•´ OCRì€ í•œ ë²ˆë§Œ ì°¨ê°ë©ë‹ˆë‹¤.</p>
  </section>

  <!-- STEP 2-A: ê°„ë‹¨ ìš”ì•½ í™”ë©´(ì½ê¸° ì „ìš©) -->
  <section id="stepSummary" class="card hidden">
    <h2 class="section-title">2) ìš”ì•½ ê²°ê³¼</h2>
    <textarea id="sumReadOnly" class="summary-box" readonly></textarea>
    <div class="row" style="grid-template-columns:1fr auto;align-items:center">
      <button id="btnBackSum" class="btn secondary">â¬… ì´ì „ í™”ë©´ìœ¼ë¡œ</button>
      <!-- âœ… ë¼ë²¨ ê³ ì •: ì¿ íŒ¡ìµœì €ê°€ ê°€ê¸° -->
      <button id="btnGoCoupangDirect" class="btn">ğŸ›’ ì¿ íŒ¡ìµœì €ê°€ ê°€ê¸°</button>
    </div>
    <p class="small">â€» ë°”ë¡œ ì´ë™ ì‹œ, ì•„ë˜ í™”ë©´ì—ì„œ ê²€ìƒ‰ì–´ë¥¼ ìˆ˜ì •í•˜ì§€ ì•Šê³  ì§„í–‰í•©ë‹ˆë‹¤.</p>
  </section>

  <!-- STEP 2-B: ì¿ íŒ¡ í‚¤ì›Œë“œ í™•ì¸/ìˆ˜ì • -->
  <section id="stepCoupang" class="card hidden">
    <h2 class="section-title">2) ì¿ íŒ¡ ê²€ìƒ‰ ì „ í™•ì¸</h2>
    <div class="row">
      <label><strong>ìš”ì•½ ë‚´ìš©</strong></label>
      <textarea id="sumBox" class="summary-box" readonly></textarea>
      <div class="grid2">
        <button id="btnEditSum" class="btn secondary">âœï¸ ìˆ˜ì •</button>
        <span class="small" style="align-self:center">â€» í•„ìš”í•  ë•Œë§Œ ìˆ˜ì •í•˜ì„¸ìš”.</span>
      </div>

      <label><strong>ê²€ìƒ‰ì–´</strong></label>
      <input id="kwFinal" type="text" placeholder="ì¿ íŒ¡ ê²€ìƒ‰ì–´" />

      <div class="grid2" style="margin-top:8px">
        <button id="btnBack2" class="btn secondary">â¬… ì´ì „ í™”ë©´ìœ¼ë¡œ</button>
        <button id="btnGoCoupang" class="btn">ğŸ›’ ìµœì €ê°€ ë³´ëŸ¬ê°€ê¸°</button>
      </div>
    </div>
  </section>

  <!-- ë³´ìƒí˜• ê´‘ê³ ë§Œ ìœ ì§€ -->
  <section class="card">
    <h3 class="section-title">ğŸ ë³´ìƒí˜• ê´‘ê³ </h3>
    <p class="small">ê´‘ê³ ë¥¼ ì‹œì²­í•˜ë©´ ì´ìš© ê°€ëŠ¥ ê±´ìˆ˜ê°€ <strong>1íšŒ</strong> ì¶©ì „ë©ë‹ˆë‹¤.</p>
    <button id="btnReward" class="btn">ê´‘ê³  ë³´ê³  1íšŒ ì¶©ì „</button>
  </section>
</main>

<script>
/* ===== ì„¤ì • ===== */
const API_BASE = window.location.origin;
const USE_MOCK = false; // ë§Œì•½ ì´ ë³€ìˆ˜ê°€ ìˆë‹¤ë©´ ê°•ì œë¡œ ì‹¤ì„œë²„ ëª¨ë“œ
const PARTNER_ID = 'AF2974050';      // ì¿ íŒ¡ íŒŒíŠ¸ë„ˆìŠ¤
const SUB_ID     = 'bigeyes';        // ì¶”ì  êµ¬ë¶„ì(ì›í•˜ë©´ ë³€ê²½)
const LS_KEY = 'be_credits_v08';
const DEFAULT_CREDITS = 3;
const MAX_CREDITS = 9999;

/* ===== ìƒíƒœ/ìš”ì†Œ ===== */
let lastImageBlob = null;
let lastOCR = null;                  // { coreSummary, (product ë¬´ì‹œ) }
let ocrDoneForThisImage = false;

const $ = id => document.getElementById(id);
const creditTop=$('creditTop'), creditTop2=$('creditTop2');
const stepUpload=$('stepUpload'), stepSummary=$('stepSummary'), stepCoupang=$('stepCoupang');
const fileCam=$('fileCam'), filePick=$('filePick'), imgPrev=$('imgPrev');
const btnAnalyze=$('btnAnalyze'), btnCoupangFlow=$('btnCoupangFlow');
const sumReadOnly=$('sumReadOnly'), btnBackSum=$('btnBackSum'), btnGoCoupangDirect=$('btnGoCoupangDirect');
const sumBox=$('sumBox'), btnEditSum=$('btnEditSum'), kwFinal=$('kwFinal');
const btnBack2=$('btnBack2'), btnGoCoupang=$('btnGoCoupang');
const btnReward=$('btnReward');

/* ===== í¬ë ˆë”§ ===== */
function clamp(n,lo,hi){return Math.max(lo,Math.min(hi,n))}
function pad4(n){return String(n).padStart(4,'0')}
function loadCredits(){const n=parseInt(localStorage.getItem(LS_KEY)||`${DEFAULT_CREDITS}`,10);return clamp(Number.isFinite(n)?n:DEFAULT_CREDITS,0,MAX_CREDITS)}
function saveCredits(n){const v=clamp(n,0,MAX_CREDITS);localStorage.setItem(LS_KEY,String(v));renderCredits(v)}
function renderCredits(v=loadCredits()){
  const txt=`(ì´ìš© ê°€ëŠ¥ ê±´ìˆ˜ : ${pad4(v)}ê±´)`;
  creditTop.textContent=txt; creditTop2.textContent=txt;
  const blocked=v<=0; fileCam.disabled=blocked; filePick.disabled=blocked;
}
(function initCredits(){const p=new URLSearchParams(location.search); if(p.has('reset')) localStorage.removeItem(LS_KEY); renderCredits();})();

/* ===== ìœ í‹¸ ===== */
function toBase64(file){return new Promise(res=>{const r=new FileReader();r.onload=()=>res(r.result.split(',')[1]);r.readAsDataURL(file);});}
function coupangAppUrl(q){return 'coupang://search?q='+encodeURIComponent(q)}
function coupangWebUrl(q){
  const base='https://www.coupang.com/np/search';
  const params=new URLSearchParams({q,channel:'user',lptag:PARTNER_ID,subId:SUB_ID});
  return `${base}?${params.toString()}`
}

/* âœ… ìš”ì•½ ê¸°ë°˜ í‚¤ì›Œë“œ ìƒì„±ê¸°: ì œí’ˆì‹ë³„ ë¯¸ì‚¬ìš© */
function buildSearchKeywordFromSummary(coreSummary='') {
  const lines = (coreSummary || '')
    .split('\n')
    .map(s => s.replace(/^-\s*/, '').trim())
    .filter(Boolean)
    .slice(0, 3);

  const STOPWORDS = ['ì£¼ì˜','ê²½ê³ ','í™•ì¸','ì‚¬ìš©ë²•','ì°¸ì¡°','ìì„¸íˆ','ìƒì„¸','í•´ë‹¹','ì œí’ˆ','ìƒí’ˆ','ê¸°ë³¸','íŠ¹ì§•','ì˜µì…˜','ì„ íƒ','ê¶Œì¥','ì£¼ì˜ì‚¬í•­','ë³´ê´€','ì´ìƒ','ì´í•˜'];

  const cleaned = lines
    .map(l => l.replace(/[()ï¼»\]ã€ã€‘{}<>:;'"â€œâ€â€˜â€™]/g,' ').replace(/\s{2,}/g,' ').trim())
    .join(' ');

  let tokens = cleaned.split(/\s+/).map(t => t.trim()).filter(Boolean)
    .map(t => t.replace(/[^0-9A-Za-zê°€-í£\-]/g,'')) // ë…¸ì´ì¦ˆ ì œê±°
    .filter(t => t.length>=2 && !STOPWORDS.includes(t));

  // ê°€ë²¼ìš´ ê°€ì¤‘ì¹˜ (ëª¨ë¸/ì¹˜ìˆ˜/ìƒ‰ìƒ/ìœ í˜• ë“±)
  const MODEL_RE=/^[A-Z0-9][A-Z0-9\-]{2,}$/;
  const SIZE_RE=/^(\d{2,4}[cmCM]|[SMLXL]{1,3}|[2-9]XL)$/;
  const COLOR_KO=/^(ë¸”ë™|í™”ì´íŠ¸|ì•„ì´ë³´ë¦¬|ê·¸ë ˆì´|ë„¤ì´ë¹„|ì¹´í‚¤|ë² ì´ì§€|ë¸Œë¼ìš´|ë ˆë“œ|ë¸”ë£¨|ê·¸ë¦°)$/;
  const TYPE_KO=/^(ë°˜íŒ”|ê¸´íŒ”|í´ë¡œ|ì…”ì¸ |ë°”ì§€|ì í¼|ìŠ¤ë‹ˆì»¤ì¦ˆ|í›„ë“œ|ìì¼“|ì›í”¼ìŠ¤|ê°€ë””ê±´)$/;

  const pri=[], sec=[];
  for(const t of tokens){
    if(MODEL_RE.test(t)||SIZE_RE.test(t)||COLOR_KO.test(t)||TYPE_KO.test(t)) pri.push(t);
    else sec.push(t);
  }
  const picked=[...sec.slice(0,6), ...pri.slice(0,4)];
  let q=picked.join(' ').replace(/\s{2,}/g,' ').trim();
  if(q.length<6 && lines.length) q=lines[0].slice(0,80);
  if(q.length>80) q=q.slice(0,80);
  return q;
}

/* âœ… ìµœì¢… ê²€ìƒ‰ì–´ ë¹Œë”: ìš”ì•½ë§Œ ì‚¬ìš© */
function buildSearchKeyword(_productIgnored={}, fallback=''){
  const fromSummary = buildSearchKeywordFromSummary(fallback || '');
  return fromSummary || '';
}

/* ===== íŒŒì¼ ì„ íƒ ===== */
async function onPick(file){
  if(!file) return;
  if(loadCredits()<=0){ alert('ì”ì—¬ ê±´ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤. ê´‘ê³  ì‹œì²­ìœ¼ë¡œ ì¶©ì „í•´ì£¼ì„¸ìš”.'); return; }
  lastImageBlob=file; imgPrev.src=URL.createObjectURL(file); imgPrev.classList.remove('hidden');
  btnAnalyze.classList.remove('hidden'); btnCoupangFlow.classList.remove('hidden');
  ocrDoneForThisImage=false; lastOCR=null;
}
fileCam.addEventListener('change',()=>onPick(fileCam.files?.[0]));
filePick.addEventListener('change',()=>onPick(filePick.files?.[0]));

/* ===== OCR (í•œ ë²ˆë§Œ ì°¨ê°) ===== */
async function ensureOCR(){
  if(!lastImageBlob) throw new Error('ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
  if(lastOCR) return lastOCR;
  if(!ocrDoneForThisImage){ const cur=loadCredits(); if(cur<=0) throw new Error('ì”ì—¬ ê±´ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.'); saveCredits(cur-1); ocrDoneForThisImage=true; }
  if(USE_MOCK){
    await new Promise(r=>setTimeout(r,500));
    lastOCR={ coreSummary:'- ì˜ˆì‹œ: ë©´ 100% ê¸°ë³¸í• í´ë¡œ ë°˜íŒ”\n- í™”ì´íŠ¸/ë„¤ì´ë¹„ ì˜µì…˜\n- ì—¬ë¦„ ìºì£¼ì–¼ ì°©ìš©ê°' };
    return lastOCR;
  }else{
    const base64=await toBase64(lastImageBlob);
    const r=await fetch(`${API_BASE}/api/summarize`,{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({imageBase64:base64,lang:'ko'})
    });
    const data=await r.json();
    if(!r.ok||!data.success) throw new Error(data.message||'ìš”ì•½ ì‹¤íŒ¨');
    lastOCR=data.payload;
    return lastOCR;
  }
}

/* ===== â‘  ì‘ì€ ê¸€ì”¨ ìš”ì•½ ===== */
btnAnalyze.addEventListener('click', async ()=>{
  try{
    const payload=await ensureOCR();
    const core = (payload.coreSummary||'').trim();
    sumReadOnly.value= core || '(ìš”ì•½ ì—†ìŒ)';

    // âœ… ìš”ì•½ í™”ë©´ì˜ "ì¿ íŒ¡ìµœì €ê°€ ê°€ê¸°"ëŠ” ìš”ì•½ë§Œìœ¼ë¡œ í‚¤ì›Œë“œ ìƒì„±
    const kw = buildSearchKeyword({}, core);
    btnGoCoupangDirect.onclick=()=>{
      if(!kw) return alert('ê²€ìƒ‰ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.');
      const app=coupangAppUrl(kw), web=coupangWebUrl(kw);
      location.href=app;
      setTimeout(()=>window.open(web,'_blank','noopener,noreferrer'),400);
    };

    stepUpload.classList.add('hidden');
    stepSummary.classList.remove('hidden');
    window.scrollTo({top:0,behavior:'smooth'});
  }catch(e){ alert(e.message||'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); }
});
btnBackSum.addEventListener('click', ()=>{
  stepSummary.classList.add('hidden');
  stepUpload.classList.remove('hidden');
});

/* ===== â‘¡ ì¿ íŒ¡ í”Œë¡œìš°: ìš”ì•½ í•œ ì¹¸ + ê²€ìƒ‰ì–´ í•œ ì¤„ ===== */
btnCoupangFlow.addEventListener('click', async ()=>{
  try{
    const payload=await ensureOCR();
    const baseSummary=(payload.coreSummary||'').trim();

    // âœ… ì œí’ˆì‹ë³„ ì¤„ ì œê±°: ììœ  ìš”ì•½ë§Œ ë…¸ì¶œ
    $('sumBox').value=baseSummary;
    $('sumBox').readOnly=true; btnEditSum.textContent='âœï¸ ìˆ˜ì •';

    // âœ… ê²€ìƒ‰ì–´ë„ ìš”ì•½ ê¸°ë°˜
    kwFinal.value=buildSearchKeyword({}, baseSummary);

    stepUpload.classList.add('hidden');
    stepCoupang.classList.remove('hidden');
    window.scrollTo({top:0,behavior:'smooth'});
  }catch(e){ alert(e.message||'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); }
});

let isEditingSummary=false;
btnEditSum.addEventListener('click', ()=>{
  isEditingSummary=!isEditingSummary;
  sumBox.readOnly=!isEditingSummary;
  btnEditSum.textContent=isEditingSummary?'âœ… ìˆ˜ì • ì™„ë£Œ':'âœï¸ ìˆ˜ì •';
  if(!isEditingSummary){
    const firstLine=(sumBox.value||'').split('\n').map(s=>s.trim()).filter(Boolean)[0]||'';
    if(firstLine && !kwFinal.value.trim()) kwFinal.value=firstLine.slice(0,80);
  }
});

btnGoCoupang.addEventListener('click', ()=>{
  const keyword=(kwFinal.value||'').trim();
  if(!keyword) return alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
  const appU=coupangAppUrl(keyword), webU=coupangWebUrl(keyword);
  location.href=appU; setTimeout(()=>window.open(webU,'_blank','noopener,noreferrer'),400);
});

btnBack2.addEventListener('click', ()=>{
  stepCoupang.classList.add('hidden');
  stepUpload.classList.remove('hidden');
});

/* ===== ë³´ìƒí˜• ê´‘ê³ (+1) ===== */
btnReward.addEventListener('click', ()=>{
  saveCredits(loadCredits()+1);
  alert('ê´‘ê³  ì‹œì²­ ì™„ë£Œ! 1íšŒ ì¶©ì „ë˜ì—ˆìŠµë‹ˆë‹¤.');
});
</script>
</body>
</html>
